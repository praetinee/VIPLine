<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointments For Staff</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn { @apply font-bold py-2 px-4 rounded w-full text-center transition-transform transform hover:scale-105; }
        .btn-green { @apply bg-green-500 hover:bg-green-600 text-white; }
        .btn-red { @apply bg-red-500 hover:bg-red-600 text-white; }
        .btn-yellow { @apply bg-yellow-500 hover:bg-yellow-600 text-black; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-view" class="flex flex-col items-center justify-center h-screen">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
    
    <!-- Admin View -->
    <div id="admin-view" class="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md mt-5 hidden">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h1>
        <p class="text-center text-gray-500 text-sm mb-4">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢: <span id="admin-appointment-id" class="font-mono"></span></p>
        <div id="admin-status-banner" class="p-3 rounded-md mb-4 text-center hidden"><p id="admin-status-text" class="font-semibold"></p></div>
        <div class="border rounded-md p-4 text-sm">
            <h2 class="text-lg font-semibold mb-3 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                <div><strong>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</strong> <span id="admin-patient-name" class="break-words"></span></div>
                <!-- ‚úÖ MODIFIED: Changed label to reflect it's optional -->
                <div><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> <span id="admin-patient-id" class="break-words"></span></div>
                <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> <span id="admin-patient-phone" class="break-words"></span></div>
                <div><strong>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠:</strong> <span id="admin-staff-name" class="break-words"></span></div>
                <!-- ‚úÖ ADDED: Doctor Name Display -->
                <div><strong>‡πÅ‡∏û‡∏ó‡∏¢‡πå:</strong> <span id="admin-doctor-name" class="break-words"></span></div>
                <div><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå:</strong> <span id="admin-patient-relation" class="break-words"></span></div>
                <div class="col-span-1 sm:col-span-2"><strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> <span id="admin-department" class="font-bold"></span></div>
                <div><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏±‡∏î:</strong> <span id="admin-appointment-type"></span></div>
                <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û:</strong> <span id="admin-patient-status"></span></div>
                <div class="col-span-1 sm:col-span-2"><strong>‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="admin-datetime-request" class="font-bold text-blue-600"></span></div>
            </div>
            <div id="admin-dental-info-wrapper" class="hidden mt-3 pt-3 border-t">
                <h3 class="font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 mt-1">
                    <div><strong>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</strong> <span id="admin-dental-service"></span></div>
                    <div><strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î:</strong> <span id="admin-dental-pain"></span></div>
                </div>
            </div>
            <div class="mt-3 pt-3 border-t"><p><strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥:</strong></p><p id="admin-symptoms" class="mt-1 p-2 bg-gray-50 rounded break-words"></p></div>
            <div class="mt-3 pt-3 border-t"><p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong></p><p id="admin-notes" class="mt-1 p-2 bg-gray-50 rounded break-words"></p></div>
        </div>
        <div class="mt-6 space-y-3">
            <div id="admin-action-buttons" class="hidden"><div class="flex flex-row gap-2"><button id="admin-approve-btn" class="btn btn-green flex-1">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button id="admin-deny-btn" class="btn btn-red flex-1">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button><button id="admin-reschedule-toggle-btn" class="btn btn-yellow flex-1">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î</button></div></div>
            <div id="reschedule-only-wrapper" class="hidden"><button id="admin-reschedule-toggle-btn-processed" class="btn btn-yellow">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ</button></div>
            <form id="admin-reschedule-form" class="mt-3 p-4 border rounded-md hidden bg-yellow-50">
                <label for="admin-new-datetime" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà</label>
                <input type="datetime-local" id="admin-new-datetime" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                <div id="admin-datetime-error" class="hidden mt-1 text-sm text-red-600"></div>

                <label for="admin-new-department" class="block text-sm font-medium text-gray-700 mt-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)</label>
                <select id="admin-new-department" name="admin-new-department" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"></select>
                
                <div id="admin-other-department-wrapper" class="hidden mt-2">
                    <label for="admin-other-department-detail" class="block text-sm font-medium text-gray-700">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å</label>
                    <input type="text" id="admin-other-department-detail" name="admin-other-department-detail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>

                <button id="admin-reschedule-submit" type="submit" class="btn btn-yellow mt-3">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î</button>
            </form>
        </div>
    </div>

    <div id="registration-view" class="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md mt-5 hidden"></div>
    <div id="main-form-view" class="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md mt-5 hidden"></div>
    
    <div id="error-view" class="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md mt-5 hidden">
        <h1 class="text-2xl font-bold text-center text-red-600 mb-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h1>
        <div class="bg-red-50 p-3 rounded-md">
            <p class="text-sm font-bold text-red-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</p>
            <pre id="error-message" class="text-xs text-red-700 whitespace-pre-wrap mt-2"></pre>
        </div>
    </div>

    <div id="success-view" class="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md mt-5 hidden">
        <div class="text-center p-6">
            <svg class="w-16 h-16 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-4">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h1>
            <p class="text-gray-600 mt-2">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
            <p class="text-gray-600 mt-1">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏£‡∏≤‡∏ö‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</p>
            <p class="text-sm text-gray-500 mt-4">‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ</p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwH3SqQVKGaIVPRouLHD7iwaSk5wYCSLdIYYxRBvgaaSNNmOnXkl356sqNUX4UiOoex2w/exec";
        const LIFF_ID = "2008050252-bNYeKBrd";

        const views = ['loading-view', 'admin-view', 'registration-view', 'main-form-view', 'error-view', 'success-view'];
        let userProfile = null;
        let staffInfo = {};

        const departmentOptionsHTML = `
            <option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
            <!-- ... existing department options ... -->
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏∏‡∏°‡∏≤‡∏£</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏î/‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πá‡∏ö</option>
            <option>‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ù‡∏≤‡∏Å‡∏Ñ‡∏£‡∏£‡∏†‡πå</option>
            <option>‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</option>
            <option>‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏£‡∏±‡∏Å‡∏©‡πå‡∏à‡∏¥‡∏ï (‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä)</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏π ‡∏Ñ‡∏≠ ‡∏à‡∏°‡∏π‡∏Å</option>
            <!-- --- ‚úÖ ADDED: "‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏≤" --- -->
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏≤</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏™‡πà‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
            <option>‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏°)</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏ã‡πÄ‡∏£‡∏¢‡πå</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏•‡∏ï‡∏£‡πâ‡∏≤‡∏ã‡∏≤‡∏ß‡∏ô‡πå</option>
            <option>‡∏´‡πâ‡∏≠‡∏á CT Scan</option>
            <option>‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ï‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á</option>
            <option>‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î</option>
            <option>‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏)</option>
        `;

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile();
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('action') === 'admin_view') {
                    await loadAdminView(urlParams.get('appointmentId'));
                } else {
                    await handleUserFlow();
                }
            } catch (error) {
                showError(`[main] ${error.message}`);
            }
        }

        function showView(viewToShow) {
            views.forEach(id => document.getElementById(id)?.classList.add('hidden'));
            document.getElementById(viewToShow)?.classList.remove('hidden');
        }

        function showError(message) {
            console.error(message);
            const errorMessage = document.getElementById('error-message');
            if (errorMessage) {
                errorMessage.textContent = message;
                showView('error-view');
            }
        }

        async function handleUserFlow() {
            try {
                showView('loading-view');
                const response = await postToServer({ action: 'checkUser', userId: userProfile.userId });
                if (response.data.isRegistered) {
                    staffInfo = response.data.staffInfo;
                    setupAndShowMainForm();
                } else {
                    setupAndShowRegistrationForm();
                }
            } catch (error) {
                showError(`[handleUserFlow] ${error.message}`);
            }
        }
        
        async function loadAdminView(appointmentId) {
            try {
                showView('loading-view');
                const response = await postToServer({ action: 'getAppointmentDetails', appointmentId });
                const details = response.data;
                
                document.getElementById('admin-appointment-id').textContent = details.uniqueId || appointmentId; // Show UniqueID if available
                document.getElementById('admin-patient-name').textContent = details.patientFullName;
                document.getElementById('admin-patient-id').textContent = details.patientId || '-';
                document.getElementById('admin-patient-phone').textContent = details.patientPhone || '-';
                
                // ‚úÖ ADDED: Doctor Name Display
                document.getElementById('admin-doctor-name').textContent = details.doctorName || '-';
                
                document.getElementById('admin-staff-name').textContent = `${details.staffFullName} (HN: ${details.staffHn})`;
                document.getElementById('admin-patient-relation').textContent = details.patientRelation;
                document.getElementById('admin-patient-status').textContent = details.patientStatus;
                document.getElementById('admin-datetime-request').textContent = new Date(details.appointmentDateTime).toLocaleString('th-TH');
                document.getElementById('admin-department').textContent = details.department || '-';
                document.getElementById('admin-symptoms').textContent = details.symptoms || '-';
                document.getElementById('admin-notes').textContent = details.notes || '-';
                
                const adminNewDepartmentSelect = document.getElementById('admin-new-department');
                adminNewDepartmentSelect.innerHTML = departmentOptionsHTML.replace('<option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>', '<option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á --</option>');
                adminNewDepartmentSelect.value = '';

                let appointmentTypeDisplay = details.appointmentType + (details.appointmentType === '‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°' ? ` (${details.followUpOnSchedule || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'})` : '');
                document.getElementById('admin-appointment-type').textContent = appointmentTypeDisplay;
                
                const dentalWrapper = document.getElementById('admin-dental-info-wrapper');
                if (details.dentalService) {
                    dentalWrapper.classList.remove('hidden');
                    document.getElementById('admin-dental-service').textContent = details.dentalService;
                    document.getElementById('admin-dental-pain').textContent = details.dentalPain || '-';
                } else {
                    dentalWrapper.classList.add('hidden');
                }
                
                const statusBanner = document.getElementById('admin-status-banner');
                const actionButtons = document.getElementById('admin-action-buttons');
                const rescheduleWrapper = document.getElementById('reschedule-only-wrapper');
                
                if (details.status === 'pending') {
                    statusBanner.classList.add('hidden');
                    actionButtons.classList.remove('hidden');
                    rescheduleWrapper.classList.add('hidden');
                } else {
                    actionButtons.classList.add('hidden');
                    rescheduleWrapper.classList.remove('hidden');
                    statusBanner.classList.remove('hidden');
                    document.getElementById('admin-status-text').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${details.status.toUpperCase()} ‡πÇ‡∏î‡∏¢ ${details.adminApprover || 'N/A'}`;
                    statusBanner.className = 'p-3 rounded-md mb-4 text-center font-semibold';
                    const statusClasses = details.status.includes('approved') ? ['bg-green-100', 'text-green-800'] : ['bg-red-100', 'text-red-800'];
                    statusBanner.classList.add(...statusClasses);
                }
                
                setupAdminButtonListeners(details.uniqueId || appointmentId); // Use UniqueID
                showView('admin-view');
            } catch (error) {
                showError(`[loadAdminView] ${error.message}`);
            }
        }
        
        function setupAndShowRegistrationForm() {
            const container = document.getElementById('registration-view');
            // --- ‚úÖ MODIFIED: Added PDPA Consent Box, Checkbox, and updated Button ---
            container.innerHTML = `
                <h1 class="text-2xl font-bold text-center text-blue-600 mb-4">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h1>
                <p class="text-gray-700 mb-4 text-center">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</p>
                <div id="reg-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
                <form id="registration-form" class="space-y-4">
                    <div>
                        <label for="reg-fullname" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠)</label>
                        <input type="text" id="reg-fullname" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    
                    <p class="text-sm text-gray-600 text-center pt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô:</p>
                    
                    <div>
                        <label for="reg-hn" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç HN</label>
                        <input type="text" id="reg-hn" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>

                    <p class="text-center text-gray-500 text-sm">‡∏´‡∏£‡∏∑‡∏≠</p>

                    <div>
                        <label for="reg-thai-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                        <input type="tel" id="reg-thai-id" pattern="\\d{13}" maxlength="13" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="1234567890123">
                    </div>

                    <!-- --- ADDED: PDPA Consent Section --- -->
                    <div class="mt-6 border rounded-md p-4 bg-gray-50">
                        <h3 class="text-base font-semibold text-center mb-3">‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Privacy Notice)</h3>
                        <div class="h-40 overflow-y-auto border rounded-md p-3 bg-white text-xs text-gray-600 space-y-2">
                            <p>‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p>
                            <p class="font-semibold mt-2">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° ‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p>
                            <ul class="list-disc list-inside ml-2">
                                <li>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</li>
                                <li>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</li>
                                <li>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô)</li>
                            </ul>
                            <p class="font-semibold mt-2">‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                            <p>‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏°‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</p>
                            <p class="font-semibold mt-2">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p>
                            <p>‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏Å‡πà‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å ‡πÄ‡∏ß‡πâ‡∏ô‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
                        </div>
                        <div class="mt-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="reg-consent-checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                                <span class="ml-2 text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ</span>
                            </label>
                        </div>
                    </div>
                    <!-- --- End of PDPA Section --- -->

                    <button type="submit" id="reg-submit-button" class="w-full flex justify-center py-2 px-4 border rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </form>`;
            
            // --- ‚úÖ ADDED: Consent Checkbox Logic ---
            const consentCheckbox = document.getElementById('reg-consent-checkbox');
            const submitButton = document.getElementById('reg-submit-button');
            
            consentCheckbox.addEventListener('change', () => {
                submitButton.disabled = !consentCheckbox.checked;
            });
            // --- End of Added Logic ---

            document.getElementById('registration-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                // --- ‚úÖ MODIFIED: Use ID to reference button ---
                const regSubmitButton = document.getElementById('reg-submit-button');
                regSubmitButton.disabled = true;
                regSubmitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...';
                
                const fullName = document.getElementById('reg-fullname').value;
                const regError = document.getElementById('reg-error-message');
                regError.classList.add('hidden');

                const hn = document.getElementById('reg-hn').value.trim();
                const thaiId = document.getElementById('reg-thai-id').value.trim();

                if (!hn && !thaiId) {
                    regError.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç HN ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á';
                    regError.classList.remove('hidden');
                    regSubmitButton.disabled = false;
                    // --- ‚úÖ MODIFIED: Reset button text correctly ---
                    regSubmitButton.textContent = '‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                    return; // Stop submission
                }

                try {
                    const response = await postToServer({ action: 'registerUser', userId: userProfile.userId, fullName, hn, thaiId });
                    
                    if (response.data.success) {
                        staffInfo = response.data.staffInfo;
                        setupAndShowMainForm();
                    } else {
                       regError.textContent = response.data.message;
                       regError.classList.remove('hidden');
                       regSubmitButton.disabled = false;
                       // --- ‚úÖ MODIFIED: Reset button text correctly ---
                       regSubmitButton.textContent = '‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                    }
                } catch (error) {
                    regError.textContent = error.message;
                    regError.classList.remove('hidden');
                    regSubmitButton.disabled = false;
                    // --- ‚úÖ MODIFIED: Reset button text correctly ---
                    regSubmitButton.textContent = '‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                }
            });
            showView('registration-view');
        }
        
        function setupAndShowMainForm() {
            const container = document.getElementById('main-form-view');
            container.innerHTML = `
                <h1 class="text-2xl font-bold text-center text-green-600 mb-4">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h1>
                <div class="bg-blue-50 p-3 rounded-md mb-4">
                    <p class="text-sm text-gray-700">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: <span id="staff-name" class="font-bold"></span></p>
                    <p class="text-sm text-gray-700">HN: <span id="staff-hn" class="font-bold"></span></p>
                </div>
                <div id="form-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"></div>
                <form id="appointment-form" class="space-y-4">
                    <fieldset class="border p-4 rounded-md">
                        <legend class="text-lg font-medium text-gray-900 px-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</legend>
                        <div><label for="patient-relation" class="block text-sm font-medium text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</label><select id="patient-relation" name="patient-relation" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"><option>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á</option><option>‡∏ö‡∏¥‡∏î‡∏≤</option><option>‡∏°‡∏≤‡∏£‡∏î‡∏≤</option><option>‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢)</option><option>‡∏ö‡∏∏‡∏ï‡∏£</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select></div>
                        <div id="other-relation-wrapper" class="hidden mt-4"><label for="other-relation-detail" class="block text-sm font-medium">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏</label><input type="text" id="other-relation-detail" name="other-relation-detail" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                        <div class="mt-4"><label for="patient-fullname" class="block text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label><input type="text" id="patient-fullname" name="patient-fullname" required class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                        
                        <!-- --- ‚úÖ MODIFICATION: Made patient-id (Thai ID) optional --- -->
                        <div class="mt-4">
                            <label for="patient-id" class="block text-sm font-medium">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                            <input type="text" id="patient-id" name="patient-id" maxlength="13" pattern="\\d{13}" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="13 ‡∏´‡∏•‡∏±‡∏Å (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
                        </div>
                        <!-- --- End of Modification --- -->
                        
                        <div class="mt-4"><label for="patient-phone" class="block text-sm font-medium">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="patient-phone" name="patient-phone" pattern="[0-9]{10}" maxlength="10" required class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                        <div class="mt-4"><label class="block text-sm font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û</label><div class="mt-2 space-x-4"><label class="inline-flex items-center"><input type="radio" name="patient-status" value="‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏î‡πâ" checked class="form-radio"><span class="ml-2">‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏î‡πâ</span></label><label class="inline-flex items-center"><input type="radio" name="patient-status" value="‡∏ô‡∏±‡πà‡∏á‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô" class="form-radio"><span class="ml-2">‡∏ô‡∏±‡πà‡∏á‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô</span></label><label class="inline-flex items-center"><input type="radio" name="patient-status" value="‡∏ô‡∏≠‡∏ô‡πÄ‡∏õ‡∏•" class="form-radio"><span class="ml-2">‡∏ô‡∏≠‡∏ô‡πÄ‡∏õ‡∏•</span></label></div></div>
                    </fieldset>
                    <fieldset class="border p-4 rounded-md">
                        <legend class="text-lg font-medium text-gray-900 px-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</legend>
                        <div><label for="symptoms" class="block text-sm font-medium">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</label><textarea id="symptoms" name="symptoms" rows="3" required class="mt-1 block w-full sm:text-sm border-gray-300 rounded-md"></textarea></div>
                        <div class="mt-4"><label for="department" class="block text-sm font-medium">‡πÅ‡∏ú‡∏ô‡∏Å</label><select id="department" name="department" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">${departmentOptionsHTML}</select></div>
                        
                        <div id="med-warning-wrapper" class="hidden mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700">
                            <p class="font-bold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏ó‡∏£‡∏≤‡∏ö</p>
                            <p class="text-sm">‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1-2 ‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å ‡∏™‡πà‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ô‡∏¥‡πà‡∏ô‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥</p>
                            <p class="text-sm mt-1">‡∏´‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏ö‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô ‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏Å "‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ" ‡πÅ‡∏ó‡∏ô‡πÑ‡∏î‡πâ</p>
                        </div>
                        
                        <!-- --- ‚úÖ MODIFIED: Added 'required' to dental questions --- -->
                        <div id="dental-options-wrapper" class="hidden mt-4 border-t pt-4">
                            <!-- Dental options HTML -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</label>
                                <div class="mt-2 space-y-2">
                                    <label class="inline-flex items-center"><input type="radio" name="dental-service" value="‡∏Ç‡∏π‡∏î‡∏´‡∏¥‡∏ô‡∏õ‡∏π‡∏ô" class="form-radio" required><span class="ml-2">‡∏Ç‡∏π‡∏î‡∏´‡∏¥‡∏ô‡∏õ‡∏π‡∏ô</span></label>
                                    <label class="inline-flex items-center"><input type="radio" name="dental-service" value="‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô" class="form-radio"><span class="ml-2">‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô</span></label>
                                    <label class="inline-flex items-center"><input type="radio" name="dental-service" value="‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô" class="form-radio"><span class="ml-2">‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô</span></label>
                                    <label class="inline-flex items-center"><input type="radio" name="dental-service" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" class="form-radio"><span class="ml-2">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span></label>
                                </div>
                                <div id="other-dental-service" class="hidden mt-2">
                                    <label for="other-dental-service-detail" class="block text-sm font-medium">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏</label>
                                    <input type="text" id="other-dental-service-detail" name="other-dental-service-detail" class="mt-1 block w-full px-3 py-2 border rounded-md">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏ü‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</label>
                                <div class="mt-2 space-x-4">
                                    <label class="inline-flex items-center"><input type="radio" name="dental-pain" value="‡∏°‡∏µ" class="form-radio" required><span class="ml-2">‡∏°‡∏µ</span></label>
                                    <label class="inline-flex items-center"><input type="radio" name="dental-pain" value="‡πÑ‡∏°‡πà‡∏°‡∏µ" class="form-radio"><span class="ml-2">‡πÑ‡∏°‡πà‡∏°‡∏µ</span></label>
                                </div>
                            </div>
                            <!-- End Dental options HTML -->
                        </div>
                        <!-- --- End of Modification --- -->
                        
                        <div id="other-department-wrapper" class="hidden mt-4"><label for="other-department-detail" class="block text-sm font-medium">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å</label><input type="text" id="other-department-detail" name="other-department-detail" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                        <div class="mt-4"><label class="block text-sm font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î</label><div class="mt-2 space-x-4"><label class="inline-flex items-center"><input type="radio" name="appointment-type" value="‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà" checked class="form-radio"><span class="ml-2">‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</span></label><label class="inline-flex items-center"><input type="radio" name="appointment-type" value="‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°" class="form-radio"><span class="ml-2">‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°</span></label></div></div>
                        
                        <!-- --- ‚úÖ MODIFIED: Doctor Name Input (now conditional) --- -->
                        <div id="doctor-name-wrapper" class="mt-4 hidden">
                            <label for="doctor-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                            <input type="text" id="doctor-name" name="doctor-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        
                        <!-- --- ‚úÖ MODIFIED: Changed follow-up options --- -->
                        <div id="follow-up-details" class="hidden mt-4">
                            <!-- Follow-up details HTML -->
                            <label for="follow-up-on-schedule" class="block text-sm font-medium text-gray-700">‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏° (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</label>
                            <div class="mt-2 space-x-4">
                                <label class="inline-flex items-center"><input type="radio" name="follow-up-on-schedule" value="‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°" class="form-radio" required><span class="ml-2">‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°</span></label>
                                <label class="inline-flex items-center"><input type="radio" name="follow-up-on-schedule" value="‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°" class="form-radio"><span class="ml-2">‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°</span></label>
                            </div>
                            <!-- End Follow-up details HTML -->
                        </div>
                        <div class="mt-4">
                            <label for="appointment-datetime" class="block text-sm font-medium">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î</label>
                            <input type="datetime-local" id="appointment-datetime" name="appointment-datetime" required class="mt-1 block w-full px-3 py-2 border rounded-md">
                            <div id="datetime-error" class="hidden mt-1 text-sm text-red-600"></div>
                        </div>
                    </fieldset>
                    <div><label for="notes" class="block text-sm font-medium">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="notes" name="notes" rows="2" class="mt-1 block w-full sm:text-sm border-gray-300 rounded-md"></textarea></div>
                    <button id="submit-button" type="submit" class="w-full flex justify-center py-2 px-4 border rounded-md text-white bg-green-600 hover:bg-green-700"><span id="submit-text">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span><div id="submit-spinner" class="spinner hidden" style="width:20px; height:20px; border-left-color: #fff;"></div></button>
                </form>
                <div class="mt-6 text-center"><p class="text-sm text-gray-600">‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p></div>
            `;
            
            document.getElementById('staff-name').textContent = staffInfo.fullName;
            document.getElementById('staff-hn').textContent = staffInfo.hn;
            
            const relationSelect = document.getElementById('patient-relation');
            const patientNameInput = document.getElementById('patient-fullname');
            if (relationSelect.value === '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á') {
                patientNameInput.value = staffInfo.fullName;
            }
            
            relationSelect.addEventListener('change', (e) => {
                document.getElementById('other-relation-wrapper').classList.toggle('hidden', e.target.value !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
                patientNameInput.value = (e.target.value === '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á') ? staffInfo.fullName : '';
            });

            const appointmentDateTimeInput = document.getElementById('appointment-datetime');
            const datetimeError = document.getElementById('datetime-error');
            const submitBtn = document.getElementById('submit-button');

            validateAndSetMinDate(appointmentDateTimeInput, datetimeError, submitBtn);
            
            // --- üî¥ START OF FIX: Force enable submit button on load ---
            // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° submit ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÇ‡∏´‡∏•‡∏î
            // ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà required ‡∏ï‡∏±‡∏ß‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏≠‡∏á
            if (submitBtn) {
                submitBtn.disabled = false;
            }
            // --- üî¥ END OF FIX ---

            document.getElementById('department').addEventListener('change', (e) => {
                document.getElementById('dental-options-wrapper').classList.toggle('hidden', e.target.value !== '‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô');
                document.getElementById('other-department-wrapper').classList.toggle('hidden', e.target.value !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
                document.getElementById('med-warning-wrapper').classList.toggle('hidden', e.target.value !== '‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°');
            });
            document.querySelectorAll('input[name="dental-service"]').forEach(r => r.addEventListener('change', (e) => {
                document.getElementById('other-dental-service').classList.toggle('hidden', e.target.value !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
            }));
            
            // --- ‚úÖ MODIFIED: Toggle doctor name visibility ---
            document.querySelectorAll('input[name="appointment-type"]').forEach(r => r.addEventListener('change', (e) => {
                const isFollowUp = e.target.value === '‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°';
                document.getElementById('follow-up-details').classList.toggle('hidden', !isFollowUp);
                document.getElementById('doctor-name-wrapper').classList.toggle('hidden', !isFollowUp);

                // --- ‚úÖ ADDED: Toggle 'required' for follow-up options ---
                document.querySelectorAll('input[name="follow-up-on-schedule"]').forEach(radio => {
                    radio.required = isFollowUp;
                });
            }));
            
            // Re-bind submit listener
            document.getElementById('appointment-form').addEventListener('submit', handleAppointmentSubmit);
            showView('main-form-view');
        }

        function setupAdminButtonListeners(appointmentId) {
            document.getElementById('admin-approve-btn').onclick = () => handleAdminActionClick('approve', appointmentId);
            document.getElementById('admin-deny-btn').onclick = () => {
                const reason = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:");
                if (reason && reason.trim()) { handleAdminActionClick('deny', appointmentId, { reason: reason.trim() }); }
            };
            const rescheduleForm = document.getElementById('admin-reschedule-form');
            const toggleReschedule = () => rescheduleForm.classList.toggle('hidden');
            document.getElementById('admin-reschedule-toggle-btn').onclick = toggleReschedule;
            document.getElementById('admin-reschedule-toggle-btn-processed').onclick = toggleReschedule;
            
            const adminDateTimeInput = document.getElementById('admin-new-datetime');
            const adminDatetimeError = document.getElementById('admin-datetime-error');
            const adminSubmitBtn = document.getElementById('admin-reschedule-submit');
            
            validateAndSetMinDate(adminDateTimeInput, adminDatetimeError, adminSubmitBtn);
            
            document.getElementById('admin-new-department').addEventListener('change', (e) => {
                document.getElementById('admin-other-department-wrapper').classList.toggle('hidden', e.target.value !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
            });

            rescheduleForm.onsubmit = (e) => {
                e.preventDefault();
                const newDateTime = document.getElementById('admin-new-datetime').value;
                if (!newDateTime) {
                    document.getElementById('admin-datetime-error').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà';
                    document.getElementById('admin-datetime-error').classList.remove('hidden');
                    return;
                }
                let newDepartment = document.getElementById('admin-new-department').value;
                if (newDepartment === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
                    newDepartment = document.getElementById('admin-other-department-detail').value;
                }
                handleAdminActionClick('reschedule', appointmentId, { newDateTime, newDepartment: newDepartment || '' });
            };
        }

        function validateAndSetMinDate(inputElement, errorElement, submitButton) {
            const now = new Date();
            const minBookingDate = new Date();
            minBookingDate.setDate(now.getDate() + 1);
            minBookingDate.setHours(8, 0, 0, 0); 
            if (now.getHours() >= 15) {
                minBookingDate.setDate(minBookingDate.getDate() + 1);
            }
            
            const tempMinDate = new Date(minBookingDate);
            tempMinDate.setMinutes(tempMinDate.getMinutes() - tempMinDate.getTimezoneOffset());
            inputElement.min = tempMinDate.toISOString().slice(0, 16);
            
            const validate = () => {
                // --- üî¥ START OF FIX ---
                if (!inputElement.value) {
                    errorElement.classList.add('hidden');
                    
                    // If the input is empty, the button should be ENABLED
                    // to allow form submission to trigger native HTML5 'required' validation.
                    // The admin form's input isn't required, so it should also be enabled.
                    submitButton.disabled = false;
                    
                    return;
                }
                // --- üî¥ END OF FIX ---

                const selected = new Date(inputElement.value);
                const day = selected.getDay();
                const hour = selected.getHours();
                
                if (day === 0 || day === 6) {
                    errorElement.textContent = '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå';
                    errorElement.classList.remove('hidden');
                    submitButton.disabled = true;
                    return;
                }

                if (hour < 8 || hour >= 15) {
                    errorElement.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 08:00-15:00 ‡∏ô.';
                    errorElement.classList.remove('hidden');
                    submitButton.disabled = true;
                    return;
                }

                // Use a slightly adjusted minBookingDate for comparison to avoid timezone issues
                const minCompareDate = new Date(minBookingDate.getTime() - 60000); // 1 minute buffer
                if (selected < minCompareDate) {
                    let errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤: ';
                    if (now.getHours() >= 15) {
                        errorMessage += '‡∏´‡∏•‡∏±‡∏á 15:00‡∏ô. ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏°‡∏∞‡∏£‡∏∑‡∏ô‡∏ô‡∏µ‡πâ';
                    } else {
                        errorMessage += '‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 15:00‡∏ô. ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
                    }
                    errorElement.textContent = errorMessage;
                    errorElement.classList.remove('hidden');
                    submitButton.disabled = true;
                    return;
                }

                errorElement.classList.add('hidden');
                // --- MODIFICATION: Allow submit if field is optional and empty ---
                // This logic is now implicitly handled by removing 'required'
                // We just need to ensure the button is enabled if valid or optionally empty.
                submitButton.disabled = false;
            };

            inputElement.addEventListener('input', validate);
            
            // --- MODIFICATION: Trigger validation on load ---
            // We call validate() but also need to check the 'required' status
            // for the submit button's initial state.
            
            // If the element is NOT required, the button should be enabled by default
            // (assuming other required fields are filled).
            /* --- üî¥ REMOVED THIS BLOCK ---
            if (!inputElement.required) {
                submitButton.disabled = false;
            }
            */
            
            // Then run validate() to set initial error messages if a value already exists
            // validate(); // --- üî¥ REMOVED THIS CALL to prevent disabling button on load
        }

        async function handleAdminActionClick(adminActionType, appointmentId, options = {}) {
            showView('loading-view');
            try {
                // --- MODIFIED (Fix for Admin Action): Send 'adminActionType' property ---
                const payload = { 
                    action: 'handleAdminAction', 
                    adminActionType: adminActionType, // 'approve', 'deny', 'reschedule'
                    appointmentId, 
                    adminName: userProfile.displayName, 
                    ...options 
                };
                const result = await postToServer(payload);
                
                // --- MODIFIED (Fix for Admin Action): Check 'alreadyProcessed' from server response ---
                if (result.data && result.data.alreadyProcessed) {
                    showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ${result.data.message}`);
                } else if (result.status === 'success') {
                    liff.closeWindow();
                } else {
                    // This case should be caught by postToServer, but as a fallback
                    showError(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏');
                }
            } catch (error) {
                showError(`[handleAdminAction] ${error.message}`);
            }
        }
        
        async function handleAppointmentSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-button');
            const spinner = document.getElementById('submit-spinner');
            const submitText = document.getElementById('submit-text');
            submitBtn.disabled = true;
            spinner.classList.remove('hidden');
            submitText.classList.add('hidden');

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            let patientRelation = data['patient-relation'] === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? data['other-relation-detail'] : data['patient-relation'];
            let department = data.department === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? data['other-department-detail'] : data.department;
            
            // --- üî¥ START OF FIX 2 ---
            // ‡∏ö‡∏±‡πä‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡∏ö ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á 'other-dental-service' ‡∏ã‡∏∂‡πà‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
            // ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á 'other-dental-service-detail' ‡∏Ñ‡∏£‡∏±‡∏ö
            let dentalService = data['dental-service'] === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? data['other-dental-service-detail'] : data['dental-service'];
            // --- üî¥ END OF FIX 2 ---

            const appointmentData = {
                action: 'submitAppointment', userId: userProfile.userId, staffFullName: staffInfo.fullName,
                staffHn: staffInfo.hn, patientRelation, patientFullName: data['patient-fullname'],
                
                // --- MODIFICATION: 'patient-id' is now optional, send whatever is provided (even empty string) ---
                patientId: data['patient-id'] || '', // Send empty string if not provided
                
                patientPhone: data['patient-phone'], 
                patientStatus: data['patient-status'], symptoms: data.symptoms,
                appointmentType: data['appointment-type'], department,
                
                // ‚úÖ ADDED: Doctor Name Submission
                doctorName: data['doctor-name'] || '',

                followUpOnSchedule: data['follow-up-on-schedule'] || '', appointmentDateTime: data['appointment-datetime'],
                notes: data.notes, isOtherRelation: data['patient-relation'] === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ',
                dentalService, dentalPain: data['dental-pain'] || ''
            };
            
            try {
                await postToServer(appointmentData);
                showView('success-view');
            } catch (error) {
                // --- üî¥ START OF FIX 3: Improve Error Handling ---
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ log ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡∏î‡∏π Error
                console.error("Submission Error:", error); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Debug
                const errorMsgElement = document.getElementById('form-error-message');
                errorMsgElement.textContent = error.message;
                errorMsgElement.classList.remove('hidden');
                // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô
                errorMsgElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); 

                submitBtn.disabled = false;
                spinner.classList.add('hidden');
                submitText.classList.remove('hidden');
                // --- üî¥ END OF FIX 3 ---
            }
        }

        async function postToServer(data) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server ${response.status}: ${errorText}`);
                }
                const result = await response.json();
                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                // --- MODIFIED (Fix for Admin Action): Return the result for checking 'alreadyProcessed' ---
                return result; 
            } catch (error) {
                throw error;
            }
        }

        main();
    </script>
</body>
</html>


