<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบนัดหมาย Fast Track</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
    </div>

    <div id="app" class="max-w-lg mx-auto p-4 sm:p-6 bg-white min-h-screen shadow-md hidden">
        
        <!-- ส่วนยืนยันตัวตน -->
        <div id="verification-section">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-teal-600">ระบบนัดหมาย Fast Track</h1>
                <p class="text-gray-600">สำหรับเจ้าหน้าที่โรงพยาบาลสันทราย</p>
            </div>
            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-4">
                <p class="text-sm text-blue-700">กรุณายืนยันตัวตนเพื่อเข้าสู่ระบบ โดยใช้ชื่อ-นามสกุล และหมายเลข HN ที่ลงทะเบียนไว้กับโรงพยาบาล</p>
            </div>
            <form id="verification-form" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล</label>
                    <input type="text" id="name" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="hn" class="block text-sm font-medium text-gray-700">หมายเลข HN</label>
                    <input type="text" id="hn" name="hn" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                </div>
                <button type="submit" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150 ease-in-out">
                    ยืนยันตัวตน
                </button>
            </form>
            <div id="verification-error" class="hidden mt-4 text-center text-red-600 bg-red-100 p-3 rounded-lg"></div>
        </div>

        <!-- ส่วนฟอร์มนัดหมาย -->
        <div id="booking-section" class="hidden">
             <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-teal-600">กรอกรายละเอียดการนัดหมาย</h1>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg mb-6 border">
                <p class="font-semibold text-gray-800">ข้อมูลเจ้าหน้าที่</p>
                <p class="text-gray-600">ชื่อ: <span id="staff-name" class="font-medium"></span></p>
                <p class="text-gray-600">HN: <span id="staff-hn" class="font-medium"></span></p>
            </div>

            <form id="booking-form" class="space-y-4">
                <!-- ข้อมูลผู้รับการรักษา -->
                <div class="border-t pt-4">
                    <label for="patient-relation" class="block text-sm font-medium text-gray-700">ผู้ที่จะเข้ารับการรักษา</label>
                    <select id="patient-relation" name="patient-relation" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        <option value="ตัวเจ้าหน้าที่เอง">ตัวเจ้าหน้าที่เอง</option>
                        <option value="พ่อ">พ่อ</option>
                        <option value="แม่">แม่</option>
                        <option value="คู่สมรส (ตามกฎหมาย)">คู่สมรส (ตามกฎหมาย)</option>
                        <option value="บุตร">บุตร</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                </div>

                <div id="relation-warning" class="hidden p-4 bg-red-100 text-red-800 rounded-lg text-sm">
                    ช่องทางนี้สำหรับเจ้าหน้าที่โรงพยาบาลและญาติสายตรงเท่านั้น <br>สำหรับบุคคลทั่วไป เพื่อความสะดวกและรวดเร็ว ขอให้ท่านติดต่อไปยังหมายเลขโทรศัพท์ <a href="tel:053921199" class="font-bold underline">053-921-199</a> หรือไลน์หลักของ รพ. สันทราย <a href="https://page.line.me/wfk5427z" target="_blank" class="font-bold underline">ที่นี่</a>
                </div>

                <div id="patient-details" class="space-y-4">
                    <div>
                        <label for="patient-name" class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล ผู้รับการรักษา</label>
                        <input type="text" id="patient-name" name="patient-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="patient-id" class="block text-sm font-medium text-gray-700">เลขบัตรประชาชน ผู้รับการรักษา</label>
                        <input type="text" id="patient-id" name="patient-id" pattern="\d{13}" title="กรุณากรอกเลขบัตรประชาชน 13 หลัก" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                     <div>
                        <label for="patient-condition" class="block text-sm font-medium text-gray-700">สถานะทางกายภาพ</label>
                        <select id="patient-condition" name="patient-condition" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            <option>เดินได้</option>
                            <option>นั่งรถเข็น</option>
                            <option>นอนเปล</option>
                        </select>
                    </div>
                </div>
               
                <!-- รายละเอียดการนัดหมาย -->
                 <div class="border-t pt-4 space-y-4">
                    <div>
                        <label for="symptoms" class="block text-sm font-medium text-gray-700">อาการ/ความผิดปกติที่ต้องการรักษา</label>
                        <textarea id="symptoms" name="symptoms" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"></textarea>
                    </div>
                    <div>
                        <fieldset>
                            <legend class="text-sm font-medium text-gray-700">ประเภทการนัด</legend>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center">
                                    <input id="new-appointment" name="appointment-type" type="radio" value="นัดใหม่" checked class="focus:ring-teal-500 h-4 w-4 text-teal-600 border-gray-300">
                                    <label for="new-appointment" class="ml-3 block text-sm text-gray-700">นัดใหม่</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="follow-up" name="appointment-type" type="radio" value="นัดเดิม" class="focus:ring-teal-500 h-4 w-4 text-teal-600 border-gray-300">
                                    <label for="follow-up" class="ml-3 block text-sm text-gray-700">นัดเดิม (Follow-up)</label>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <div id="follow-up-options" class="hidden pl-5 space-y-4 mt-2">
                         <fieldset>
                            <legend class="text-sm font-medium text-gray-700">สถานะการมาตามนัดเดิม</legend>
                             <div class="mt-2 space-y-2">
                                <div class="flex items-center">
                                    <input id="on-schedule" name="follow-up-status" type="radio" value="มาตรงตามใบนัด" class="focus:ring-teal-500 h-4 w-4 text-teal-600 border-gray-300">
                                    <label for="on-schedule" class="ml-3 block text-sm text-gray-700">มาตรงตามใบนัด</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="off-schedule" name="follow-up-status" type="radio" value="ไม่ได้มาตามนัด" class="focus:ring-teal-500 h-4 w-4 text-teal-600 border-gray-300">
                                    <label for="off-schedule" class="ml-3 block text-sm text-gray-700">ไม่ได้มาตามนัด</label>
                                </div>
                             </div>
                        </fieldset>
                        <div>
                            <label for="department" class="block text-sm font-medium text-gray-700">แผนกที่นัดเดิม</label>
                            <input type="text" id="department" name="department" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        </div>
                    </div>

                    <div>
                        <label for="appointment-datetime" class="block text-sm font-medium text-gray-700">วันและเวลาที่ต้องการนัด</label>
                        <input type="datetime-local" id="appointment-datetime" name="appointment-datetime" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        <p id="datetime-error" class="hidden mt-1 text-xs text-red-600">สามารถนัดได้วันจันทร์-ศุกร์ เวลา 08:00 - 15:00 น. เท่านั้น</p>
                    </div>

                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">หมายเหตุ (ถ้ามี)</label>
                        <textarea id="notes" name="notes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"></textarea>
                    </div>
                </div>
                
                <button type="submit" id="submit-booking" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150 ease-in-out">
                    ส่งข้อมูลการนัดหมาย
                </button>
            </form>
        </div>

        <!-- ส่วนข้อความสถานะ -->
        <div id="status-section" class="hidden text-center py-10">
            <svg class="mx-auto h-12 w-12 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="mt-4 text-xl font-semibold text-gray-800">ส่งข้อมูลสำเร็จ!</h2>
            <p class="mt-2 text-gray-600">เราได้ส่งคำขอนัดหมายของคุณแล้ว กรุณาตรวจสอบสถานะในห้องแชท LINE และรอการยืนยันจากเจ้าหน้าที่</p>
             <button onclick="liff.closeWindow()" class="mt-6 w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">ปิดหน้านี้</button>
        </div>
        
        <div class="mt-8 text-center">
            <button id="contact-button" class="text-sm text-gray-500 underline hover:text-teal-600">พบปัญหา? ติดต่อเจ้าหน้าที่</button>
        </div>
    </div>

    <script>
        // =======================================================================
        // การตั้งค่า - กรุณาแก้ไขค่าเหล่านี้ตามที่ได้จาก Google Apps Script
        // =======================================================================
        const LIFF_ID = "YOUR_LIFF_ID"; // <--- กรอก LIFF ID ของคุณที่นี่
        const GAS_WEB_APP_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL"; // <--- กรอก URL ของ Web App ที่นี่

        // =======================================================================
        // ตัวแปรและ Element References
        // =======================================================================
        let userId = null;
        let staffProfile = {};

        const loadingDiv = document.getElementById('loading');
        const appDiv = document.getElementById('app');
        
        const verificationSection = document.getElementById('verification-section');
        const verificationForm = document.getElementById('verification-form');
        const verificationError = document.getElementById('verification-error');
        
        const bookingSection = document.getElementById('booking-section');
        const bookingForm = document.getElementById('booking-form');
        const staffNameSpan = document.getElementById('staff-name');
        const staffHnSpan = document.getElementById('staff-hn');
        
        const patientRelationSelect = document.getElementById('patient-relation');
        const relationWarningDiv = document.getElementById('relation-warning');
        const patientDetailsDiv = document.getElementById('patient-details');
        const patientNameInput = document.getElementById('patient-name');
        const submitBookingBtn = document.getElementById('submit-booking');
        
        const appointmentTypeRadios = document.querySelectorAll('input[name="appointment-type"]');
        const followUpOptionsDiv = document.getElementById('follow-up-options');

        const datetimeInput = document.getElementById('appointment-datetime');
        const datetimeError = document.getElementById('datetime-error');
        
        const statusSection = document.getElementById('status-section');
        const contactButton = document.getElementById('contact-button');

        // =======================================================================
        // Main Logic
        // =======================================================================
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                userId = profile.userId;
                showPage('verification');
            } catch (error) {
                console.error('LIFF Initialization failed', error);
                alert('เกิดข้อผิดพลาดในการเริ่มต้นแอปพลิเคชัน กรุณาลองใหม่อีกครั้ง');
            }
        }

        main();

        // =======================================================================
        // Event Listeners
        // =======================================================================

        // ยืนยันตัวตน
        verificationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const formData = new FormData(verificationForm);
            const data = {
                action: 'verifyStaff',
                name: formData.get('name'),
                hn: formData.get('hn'),
            };

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                if (result.status === 'success' && result.data.isStaff) {
                    staffProfile = {
                        name: data.name,
                        hn: data.hn
                    };
                    setupBookingForm();
                    showPage('booking');
                } else {
                    verificationError.textContent = 'ข้อมูลไม่ถูกต้อง หรือไม่พบรายชื่อในระบบ กรุณาตรวจสอบและลองอีกครั้ง';
                    verificationError.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Verification error:', error);
                verificationError.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองใหม่';
                verificationError.classList.remove('hidden');
            } finally {
                showLoading(false);
            }
        });

        // ฟอร์มนัดหมาย
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validateDateTime()) return;
            
            showLoading(true);
            const formData = new FormData(bookingForm);
            const appointmentType = formData.get('appointment-type');
            let followUpStatus = '';
            let department = '';
            if (appointmentType === 'นัดเดิม') {
                followUpStatus = formData.get('follow-up-status');
                department = formData.get('department');
                if (!followUpStatus) {
                    alert('กรุณาเลือกสถานะการมาตามนัดเดิม');
                    showLoading(false);
                    return;
                }
                 if (!department) {
                    alert('กรุณากรอกแผนกที่นัดเดิม');
                    showLoading(false);
                    return;
                }
            }

            const data = {
                action: 'submitBooking',
                userId: userId,
                staffName: staffProfile.name,
                staffHn: staffProfile.hn,
                patientRelation: formData.get('patient-relation'),
                patientName: formData.get('patient-name'),
                patientId: formData.get('patient-id'),
                patientCondition: formData.get('patient-condition'),
                symptoms: formData.get('symptoms'),
                appointmentType: appointmentType,
                followUpStatus: followUpStatus,
                department: department,
                appointmentDateTime: formData.get('appointment-datetime'),
                notes: formData.get('notes')
            };

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showPage('status');
                } else {
                    alert(`เกิดข้อผิดพลาด: ${result.message}`);
                }
            } catch (error) {
                console.error('Booking submission error:', error);
                alert('เกิดข้อผิดพลาดในการส่งข้อมูล กรุณาลองใหม่อีกครั้ง');
            } finally {
                showLoading(false);
            }
        });

        // จัดการเมื่อเลือกความสัมพันธ์
        patientRelationSelect.addEventListener('change', (e) => {
            const isOther = e.target.value === 'อื่นๆ';
            relationWarningDiv.classList.toggle('hidden', !isOther);
            patientDetailsDiv.classList.toggle('hidden', isOther);
            submitBookingBtn.disabled = isOther;

            if (e.target.value === 'ตัวเจ้าหน้าที่เอง') {
                patientNameInput.value = staffProfile.name;
            } else {
                 patientNameInput.value = '';
            }
        });
        
        // จัดการเมื่อเลือกประเภทการนัด
        appointmentTypeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                followUpOptionsDiv.classList.toggle('hidden', radio.value !== 'นัดเดิม');
                const departmentInput = document.getElementById('department');
                const followUpInputs = followUpOptionsDiv.querySelectorAll('input[name="follow-up-status"]');

                if (radio.value === 'นัดเดิม') {
                    departmentInput.required = true;
                } else {
                    departmentInput.required = false;
                    departmentInput.value = '';
                    followUpInputs.forEach(input => input.checked = false);
                }
            });
        });

        // ตรวจสอบวัน-เวลาที่เลือก
        datetimeInput.addEventListener('change', validateDateTime);
        
        // ปุ่มติดต่อเจ้าหน้าที่
        contactButton.addEventListener('click', () => {
            // คุณสามารถเปลี่ยนข้อความนี้เป็นข้อความแนะนำหรือลิงก์ไปยัง LINE OA ของแอดมินได้
             liff.sendMessages([{
                type: 'text',
                text: 'ฉันพบปัญหาในการใช้งานระบบนัดหมาย Fast Track'
            }]).then(() => {
                liff.closeWindow();
            }).catch((err) => {
                console.error('Send message error:', err);
            });
        });

        // =======================================================================
        // Helper Functions
        // =======================================================================
        function showPage(page) {
            verificationSection.classList.add('hidden');
            bookingSection.classList.add('hidden');
            statusSection.classList.add('hidden');

            if (page === 'verification') {
                verificationSection.classList.remove('hidden');
            } else if (page === 'booking') {
                bookingSection.classList.remove('hidden');
            } else if (page === 'status') {
                statusSection.classList.remove('hidden');
            }
            showLoading(false);
            appDiv.classList.remove('hidden');
        }
        
        function showLoading(isLoading) {
            loadingDiv.style.display = isLoading ? 'flex' : 'none';
        }

        function setupBookingForm() {
            staffNameSpan.textContent = staffProfile.name;
            staffHnSpan.textContent = staffProfile.hn;
            patientNameInput.value = staffProfile.name;
        }

        function validateDateTime() {
            const selectedDate = new Date(datetimeInput.value);
            const day = selectedDate.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const hour = selectedDate.getHours();
            
            // Check if day is Saturday (6) or Sunday (0)
            const isWeekend = day === 0 || day === 6;
            // Check if time is outside 8:00 - 15:00
            const isOutsideHours = hour < 8 || hour >= 15;

            if (isWeekend || isOutsideHours) {
                datetimeError.classList.remove('hidden');
                submitBookingBtn.disabled = true;
                return false;
            } else {
                datetimeError.classList.add('hidden');
                submitBookingBtn.disabled = false;
                return true;
            }
        }
    </script>
</body>
</html>

