<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointments For Staff</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn { @apply font-bold py-2 px-4 rounded w-full text-center transition-transform transform hover:scale-105; }
        .btn-green { @apply bg-green-500 hover:bg-green-600 text-white; }
        .btn-red { @apply bg-red-500 hover:bg-red-600 text-white; }
        .btn-yellow { @apply bg-yellow-500 hover:bg-yellow-600 text-black; }
        .btn-gray { @apply bg-gray-500 hover:bg-gray-600 text-white; } 
        .btn-disabled { @apply bg-gray-400 text-white cursor-not-allowed transform-none; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-view" class="flex flex-col items-center justify-center h-screen">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
    
    <!-- Admin View -->
    <div id="admin-view" class="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md mt-5 hidden">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h1>
        <p class="text-center text-gray-500 text-sm mb-4">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢: <span id="admin-appointment-id" class="font-mono"></span></p>
        
        <!-- Status Banner -->
        <div id="admin-status-banner" class="p-3 rounded-md mb-4 text-center hidden"><p id="admin-status-text" class="font-semibold"></p></div>
        
        <div class="border rounded-md p-4 text-sm">
            <h2 class="text-lg font-semibold mb-3 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                <div><strong>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</strong> <span id="admin-patient-name" class="break-words"></span></div>
                <div><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> <span id="admin-patient-id" class="break-words"></span></div>
                <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> <span id="admin-patient-phone" class="break-words text-blue-600 font-bold"></span></div>
                <div><strong>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠:</strong> <span id="admin-staff-name" class="break-words"></span></div>
                <div><strong>‡πÅ‡∏û‡∏ó‡∏¢‡πå:</strong> <span id="admin-doctor-name" class="break-words"></span></div>
                <div><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå:</strong> <span id="admin-patient-relation" class="break-words"></span></div>
                <div class="col-span-1 sm:col-span-2"><strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> <span id="admin-department" class="font-bold"></span></div>
                <div><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏±‡∏î:</strong> <span id="admin-appointment-type"></span></div>
                <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û:</strong> <span id="admin-patient-status"></span></div>
                <div class="col-span-1 sm:col-span-2"><strong>‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="admin-datetime-request" class="font-bold text-blue-600"></span></div>
            </div>
            
            <div id="admin-dental-info-wrapper" class="hidden mt-3 pt-3 border-t">
                <h3 class="font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 mt-1">
                    <div><strong>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</strong> <span id="admin-dental-service"></span></div>
                    <div><strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î:</strong> <span id="admin-dental-pain"></span></div>
                </div>
            </div>

            <!-- TTM Assessment Info -->
            <div id="admin-ttm-info-wrapper" class="hidden mt-3 pt-3 border-t">
                <h3 class="font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h3>
                <div id="admin-ttm-symptoms-list" class="mt-2 text-sm space-y-1"></div>
                <div class="mt-2"><strong>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> <span id="admin-ttm-seen-doctor-status" class="font-bold"></span></div>
                <div id="admin-ttm-alert-box" class="mt-2 p-2 rounded text-xs font-bold hidden"></div>
            </div>

            <div class="mt-3 pt-3 border-t"><p><strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥:</strong></p><p id="admin-symptoms" class="mt-1 p-2 bg-gray-50 rounded break-words"></p></div>
            <div class="mt-3 pt-3 border-t"><p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong></p><p id="admin-notes" class="mt-1 p-2 bg-gray-50 rounded break-words"></p></div>
        </div>

        <!-- History Log Section -->
        <div id="admin-history-section" class="mt-4 p-4 border rounded-md bg-gray-50 hidden">
            <h3 class="font-bold text-gray-700 mb-2">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (History)</h3>
            <div id="admin-history-list" class="text-xs text-gray-600 space-y-3 whitespace-pre-wrap"></div>
        </div>

        <!-- Admin Safety Checks (Visible before actions) -->
        <div id="admin-safety-checks" class="mt-4 hidden">
            
            <!-- Dental Safety Check -->
            <div id="dental-safety-check" class="hidden bg-yellow-50 border border-yellow-300 p-3 rounded mb-3">
                <p class="font-bold text-yellow-800 text-sm mb-2">‚ö†Ô∏è ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô)</p>
                <label class="flex items-start space-x-2">
                    <input type="checkbox" id="dental-confirm-call" class="mt-1 h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                    <span class="text-sm text-gray-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á (‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£+‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î) ‡πÉ‡∏´‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</span>
                </label>
            </div>

            <!-- Psych Safety Check (New) -->
            <div id="psych-safety-check" class="hidden bg-red-50 border border-red-300 p-3 rounded mb-3">
                <p class="font-bold text-red-800 text-sm mb-2">‚ö†Ô∏è ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä)</p>
                <!-- ‚úÖ FIX: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô -->
                <p class="text-xs text-gray-700 mb-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ ‡πÉ‡∏´‡πâ ‡∏à‡∏ô‡∏ó. ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏£‡∏±‡∏Å‡∏©‡πå‡∏à‡∏¥‡∏ï ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ó‡∏£‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ó‡∏£‡πÄ‡∏≠‡∏á)</p>
                <label class="flex items-start space-x-2">
                    <input type="checkbox" id="psych-confirm-call" class="mt-1 h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                    <!-- ‚úÖ FIX: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Checkbox -->
                    <span class="text-sm text-gray-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                </label>
            </div>

            <!-- PT Safety Check -->
            <div id="pt-safety-check" class="hidden bg-blue-50 border border-blue-300 p-3 rounded mb-3">
                <p class="font-bold text-blue-800 text-sm mb-2">‚ö†Ô∏è ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå (‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)</p>
                <p class="text-xs text-gray-600 mb-2">‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå PMR ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏≠‡∏≠‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                <div class="space-y-2">
                    <label class="inline-flex items-center">
                        <input type="radio" name="pt-pmr-status" value="pmr_available" class="form-radio text-green-600">
                        <span class="ml-2 text-sm">‡∏´‡∏°‡∏≠ PMR ‡∏≠‡∏¢‡∏π‡πà (‡πÑ‡∏õ‡∏ï‡∏∂‡∏Å‡∏ä‡∏°‡∏û‡∏π)</span>
                    </label>
                    <br>
                    <label class="inline-flex items-center">
                        <input type="radio" name="pt-pmr-status" value="no_pmr" class="form-radio text-red-600">
                        <span class="ml-2 text-sm">‡∏´‡∏°‡∏≠ PMR ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏™‡πà‡∏á‡πÑ‡∏õ Ortho)</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="mt-6 space-y-3">
            <!-- Main Action Buttons -->
            <div id="admin-action-buttons" class="hidden">
                <div class="flex flex-row gap-2">
                    <button id="admin-approve-btn" class="btn btn-green flex-1">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    <button id="admin-deny-btn" class="btn btn-red flex-1">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    <button id="admin-reschedule-toggle-btn" class="btn btn-yellow flex-1">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î</button>
                </div>
            </div>

            <!-- Special Confirmation for High Risk TTM -->
            <div id="ttm-confirm-view" class="hidden bg-red-50 border border-red-200 p-4 rounded-md">
                <h3 class="text-red-700 font-bold text-lg mb-2">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?</h3>
                <p class="text-sm text-gray-700 mb-4">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ Redirect)</p>
                <div class="flex gap-2">
                    <button id="ttm-confirm-back-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button id="ttm-confirm-approve-btn" class="btn bg-red-600 text-white hover:bg-red-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</button>
                </div>
            </div>

            <div id="reschedule-only-wrapper" class="hidden"><button id="admin-reschedule-toggle-btn-processed" class="btn btn-yellow">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ</button></div>
            
            <!-- Reschedule Form -->
            <form id="admin-reschedule-form" class="mt-3 p-4 border rounded-md hidden bg-yellow-50">
                <h3 id="reschedule-form-title" class="font-bold mb-3">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h3>
                <p id="redirect-warning-text" class="text-xs text-red-600 mb-2 hidden">‚ö†Ô∏è ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å (Redirect) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>

                <label for="admin-new-datetime" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà</label>
                <input type="datetime-local" id="admin-new-datetime" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                <div id="admin-datetime-error" class="hidden mt-1 text-sm text-red-600"></div>

                <label for="admin-new-department" class="block text-sm font-medium text-gray-700 mt-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)</label>
                <select id="admin-new-department" name="admin-new-department" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"></select>
                
                <div id="admin-other-department-wrapper" class="hidden mt-2">
                    <label for="admin-other-department-detail" class="block text-sm font-medium text-gray-700">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å</label>
                    <input type="text" id="admin-other-department-detail" name="admin-other-department-detail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>

                <button id="admin-reschedule-submit" type="submit" class="btn btn-yellow mt-3">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î</button>
            </form>
        </div>
    </div>

    <!-- Registration & Main Forms -->
    <div id="registration-view" class="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md mt-5 hidden"></div>
    <div id="main-form-view" class="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md mt-5 hidden"></div>
    
    <div id="error-view" class="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md mt-5 hidden">
        <h1 class="text-2xl font-bold text-center text-red-600 mb-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h1>
        <div class="bg-red-50 p-3 rounded-md">
            <pre id="error-message" class="text-xs text-red-700 whitespace-pre-wrap mt-2"></pre>
        </div>
    </div>

    <div id="success-view" class="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md mt-5 hidden">
        <div class="text-center p-6">
            <svg class="w-16 h-16 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-4">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h1>
            <p class="text-gray-600 mt-2">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
            <p class="text-gray-600 mt-1">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏£‡∏≤‡∏ö‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</p>
            <p class="text-sm text-gray-500 mt-4">‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ</p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwH3SqQVKGaIVPRouLHD7iwaSk5wYCSLdIYYxRBvgaaSNNmOnXkl356sqNUX4UiOoex2w/exec";
        const LIFF_ID = "2008050252-bNYeKBrd";

        const views = ['loading-view', 'admin-view', 'registration-view', 'main-form-view', 'error-view', 'success-view'];
        let userProfile = null;
        let staffInfo = {};
        
        // --- DATA ---
        const departmentOptionsHTML = `
            <option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏∏‡∏°‡∏≤‡∏£</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏î/‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πá‡∏ö</option>
            <option>‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ù‡∏≤‡∏Å‡∏Ñ‡∏£‡∏£‡∏†‡πå</option>
            <option>‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</option>
            <option>‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏£‡∏±‡∏Å‡∏©‡πå‡∏à‡∏¥‡∏ï (‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä)</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏π ‡∏Ñ‡∏≠ ‡∏à‡∏°‡∏π‡∏Å</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏≤</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô</option>
            <option>‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏™‡πà‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
            <option>‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏°)</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏ã‡πÄ‡∏£‡∏¢‡πå</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏•‡∏ï‡∏£‡πâ‡∏≤‡∏ã‡∏≤‡∏ß‡∏ô‡πå</option>
            <option>‡∏´‡πâ‡∏≠‡∏á CT Scan</option>
            <option>‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ï‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á</option>
            <option>‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏)</option>
        `;

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile();
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('action') === 'admin_view') {
                    await loadAdminView(urlParams.get('appointmentId'));
                } else {
                    await handleUserFlow();
                }
            } catch (error) {
                showError(`[main] ${error.message}`);
            }
        }

        function showView(viewToShow) {
            views.forEach(id => document.getElementById(id)?.classList.add('hidden'));
            document.getElementById(viewToShow)?.classList.remove('hidden');
        }

        function showError(message) {
            console.error(message);
            const errorMessage = document.getElementById('error-message');
            if (errorMessage) {
                errorMessage.textContent = message;
                showView('error-view');
            }
        }

        async function handleUserFlow() {
            try {
                showView('loading-view');
                const response = await postToServer({ action: 'checkUser', userId: userProfile.userId });
                if (response.data.isRegistered) {
                    staffInfo = response.data.staffInfo;
                    setupAndShowMainForm();
                } else {
                    setupAndShowRegistrationForm();
                }
            } catch (error) {
                showError(`[handleUserFlow] ${error.message}`);
            }
        }
        
        async function loadAdminView(appointmentId) {
            try {
                showView('loading-view');
                const response = await postToServer({ action: 'getAppointmentDetails', appointmentId });
                const details = response.data;
                
                document.getElementById('admin-appointment-id').textContent = details.uniqueId || appointmentId;
                document.getElementById('admin-patient-name').textContent = details.patientFullName;
                document.getElementById('admin-patient-id').textContent = details.patientId || '-';
                document.getElementById('admin-patient-phone').textContent = details.patientPhone || '-';
                document.getElementById('admin-doctor-name').textContent = details.doctorName || '-';
                document.getElementById('admin-staff-name').textContent = `${details.staffFullName} (HN: ${details.staffHn})`;
                document.getElementById('admin-patient-relation').textContent = details.patientRelation;
                document.getElementById('admin-patient-status').textContent = details.patientStatus;
                document.getElementById('admin-datetime-request').textContent = new Date(details.appointmentDateTime).toLocaleString('th-TH');
                document.getElementById('admin-department').textContent = details.department || '-';
                // ‚úÖ FIX: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏±‡∏î (Appointment Type) ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin View
                document.getElementById('admin-appointment-type').textContent = details.appointmentType || '-'; 
                document.getElementById('admin-symptoms').textContent = details.symptoms || '-';
                document.getElementById('admin-notes').textContent = details.notes || '-';
                
                // Show History
                if (details.actionHistory) {
                    document.getElementById('admin-history-section').classList.remove('hidden');
                    document.getElementById('admin-history-list').textContent = details.actionHistory;
                } else {
                    document.getElementById('admin-history-section').classList.add('hidden');
                }

                // --- Department Specific Logic ---
                const dentalWrapper = document.getElementById('admin-dental-info-wrapper');
                const ttmWrapper = document.getElementById('admin-ttm-info-wrapper');
                const ttmList = document.getElementById('admin-ttm-symptoms-list');
                const ttmAlert = document.getElementById('admin-ttm-alert-box');
                const ttmSeenDoctorStatus = document.getElementById('admin-ttm-seen-doctor-status');
                
                // Hide all first
                dentalWrapper.classList.add('hidden');
                ttmWrapper.classList.add('hidden');
                
                // Dental View
                if (details.dentalService) {
                    dentalWrapper.classList.remove('hidden');
                    document.getElementById('admin-dental-service').textContent = details.dentalService;
                    // Highlight Pain Status
                    const painElem = document.getElementById('admin-dental-pain');
                    painElem.textContent = details.dentalPain || '-';
                    if(details.dentalPain === '‡∏°‡∏µ') {
                        painElem.className = 'text-red-600 font-bold';
                    } else {
                        painElem.className = '';
                    }
                }

                // TTM View (Logic: Green/Orange/Red)
                let isHighRiskTTM = false;
                let isNeverSeenDoctor = false;

                if (details.department === '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢' && details.ttmSymptoms) {
                    ttmWrapper.classList.remove('hidden');
                    ttmList.innerHTML = '';
                    
                    // Safe parse in case of unexpected data, though server handles it well now
                    let symptoms = [];
                    try { symptoms = JSON.parse(details.ttmSymptoms); } catch(e) {}
                    
                    const highRisks = ['muscle_weakness', 'recent_accident', 'bone_issue', 'cancer'];
                    
                    symptoms.forEach(sym => {
                        let text = getSymptomLabel(sym);
                        let colorClass = 'text-green-600';
                        if (highRisks.includes(sym)) {
                            colorClass = 'text-red-600 font-bold';
                            isHighRiskTTM = true;
                        }
                        const p = document.createElement('p');
                        p.className = colorClass;
                        p.textContent = `‚Ä¢ ${text}`;
                        ttmList.appendChild(p);
                    });

                    // Explicitly show seen doctor status
                    if (details.ttmSeenDoctor === 'yes') {
                        ttmSeenDoctorStatus.textContent = '‡πÄ‡∏Ñ‡∏¢‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏Å‡∏©‡∏≤)';
                        ttmSeenDoctorStatus.className = 'font-bold text-green-600';
                    } else if (details.ttmSeenDoctor === 'no') {
                        ttmSeenDoctorStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå';
                        ttmSeenDoctorStatus.className = 'font-bold text-red-600';
                    } else {
                        ttmSeenDoctorStatus.textContent = '-';
                        ttmSeenDoctorStatus.className = 'font-bold text-gray-600';
                    }

                    if (isHighRiskTTM) {
                        if (details.ttmSeenDoctor === 'no') {
                            isNeverSeenDoctor = true;
                            ttmAlert.textContent = "‚õî ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á: ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å)";
                            ttmAlert.className = 'mt-2 p-2 rounded text-xs font-bold bg-red-100 text-red-700 block';
                        } else {
                            ttmAlert.textContent = "‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á: ‡πÅ‡∏ï‡πà‡πÄ‡∏Ñ‡∏¢‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß (‡πÇ‡∏õ‡∏£‡∏î‡πÇ‡∏ó‡∏£‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)";
                            ttmAlert.className = 'mt-2 p-2 rounded text-xs font-bold bg-orange-100 text-orange-700 block';
                        }
                    } else {
                        // ‚úÖ FIX: Even Low Risk needs to warn about calling queue
                        ttmAlert.textContent = "‚ö†Ô∏è ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥: ‡πÇ‡∏õ‡∏£‡∏î‡πÇ‡∏ó‡∏£‡∏•‡∏á‡∏Ñ‡∏¥‡∏ß‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";
                        ttmAlert.className = 'mt-2 p-2 rounded text-xs font-bold bg-yellow-100 text-yellow-700 block';
                    }
                    ttmAlert.classList.remove('hidden');
                }

                // --- Admin Action Logic ---
                const statusBanner = document.getElementById('admin-status-banner');
                const actionButtons = document.getElementById('admin-action-buttons');
                const rescheduleWrapper = document.getElementById('reschedule-only-wrapper');
                const safetyChecks = document.getElementById('admin-safety-checks');
                const dentalSafety = document.getElementById('dental-safety-check');
                const psychSafety = document.getElementById('psych-safety-check'); // NEW
                const ptSafety = document.getElementById('pt-safety-check');
                
                // Elements
                const approveBtn = document.getElementById('admin-approve-btn');
                const denyBtn = document.getElementById('admin-deny-btn');
                const rescheduleBtn = document.getElementById('admin-reschedule-toggle-btn');

                // Reset visibility
                approveBtn.classList.remove('hidden');
                denyBtn.classList.remove('hidden');
                rescheduleBtn.classList.remove('hidden');
                denyBtn.className = 'btn btn-red flex-1'; // Reset class

                if (details.status === 'pending') {
                    // Case 1: Pending
                    statusBanner.classList.add('hidden');
                    actionButtons.classList.remove('hidden');
                    rescheduleWrapper.classList.add('hidden');
                    
                    // Buttons
                    denyBtn.textContent = "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò";
                    denyBtn.onclick = () => promptDenyOrCancel(appointmentId, 'deny');

                    // Show Safety Checks Container
                    safetyChecks.classList.remove('hidden');
                    
                    // 1. Dental Safety
                    if (details.department === '‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô') {
                        dentalSafety.classList.remove('hidden');
                    } else {
                        dentalSafety.classList.add('hidden');
                    }

                    // 2. Psych Safety (NEW)
                    const isPsych = details.department && (details.department.includes('‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏£‡∏±‡∏Å‡∏©‡πå‡∏à‡∏¥‡∏ï') || details.department.includes('‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä'));
                    const isNewAppt = details.appointmentType === '‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà';
                    
                    if (isPsych && isNewAppt) {
                        psychSafety.classList.remove('hidden');
                    } else {
                        psychSafety.classList.add('hidden');
                    }

                    // 3. PT Safety (Only for New Appointment)
                    if (details.department === '‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î' && isNewAppt) {
                        ptSafety.classList.remove('hidden');
                    } else {
                        ptSafety.classList.add('hidden');
                    }

                    // TTM Logic
                    if (isHighRiskTTM && isNeverSeenDoctor) {
                        approveBtn.classList.add('btn-disabled');
                        approveBtn.disabled = true;
                        approveBtn.textContent = "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á)";
                        rescheduleBtn.classList.add('ring-2', 'ring-red-500');
                        document.getElementById('redirect-warning-text').classList.remove('hidden');
                        document.getElementById('reschedule-form-title').textContent = "‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î / ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å (Redirect)";
                        
                        approveBtn.disabled = false;
                        approveBtn.classList.remove('btn-disabled');
                        approveBtn.onclick = () => {
                            actionButtons.classList.add('hidden');
                            document.getElementById('ttm-confirm-view').classList.remove('hidden');
                        };
                    } else {
                         approveBtn.onclick = () => checkSafetyAndApprove(details.department, details.uniqueId || appointmentId, details.appointmentType);
                         document.getElementById('redirect-warning-text').classList.add('hidden');
                    }

                } else {
                    // Case 2: Already Processed
                    statusBanner.classList.remove('hidden');
                    document.getElementById('admin-status-text').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${details.status.toUpperCase()} ‡πÇ‡∏î‡∏¢ ${details.adminApprover || 'N/A'}`;
                    statusBanner.className = 'p-3 rounded-md mb-4 text-center font-semibold';
                    
                    let statusClasses = ['bg-gray-100', 'text-gray-800'];
                    if (details.status.includes('approved')) statusClasses = ['bg-green-100', 'text-green-800'];
                    if (details.status.includes('denied') || details.status.includes('cancelled')) statusClasses = ['bg-red-100', 'text-red-800'];
                    statusBanner.classList.add(...statusClasses);

                    // Show buttons but Hide Approve
                    actionButtons.classList.remove('hidden');
                    approveBtn.classList.add('hidden');
                    safetyChecks.classList.add('hidden');
                    rescheduleWrapper.classList.add('hidden');

                    // Handle Cancel Button
                    if (details.status.includes('approved')) {
                        denyBtn.textContent = "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢";
                        denyBtn.classList.remove('btn-red');
                        denyBtn.classList.add('btn-gray');
                        denyBtn.onclick = () => promptDenyOrCancel(appointmentId, 'cancel');
                    } else {
                        denyBtn.classList.add('hidden'); // Already denied/cancelled
                    }
                }
                
                setupRescheduleAndDeny(details.uniqueId || appointmentId, isHighRiskTTM && isNeverSeenDoctor);
                showView('admin-view');
            } catch (error) {
                showError(`[loadAdminView] ${error.message}`);
            }
        }

        function promptDenyOrCancel(appointmentId, actionType) {
            const actionText = actionType === 'cancel' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢';
            const reason = prompt(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£${actionText}:`);
            if (reason && reason.trim()) { 
                handleAdminActionClick(actionType, appointmentId, { reason: reason.trim() }); 
            }
        }

        function checkSafetyAndApprove(department, appointmentId, appointmentType) {
            // 1. Dental Check
            if (department === '‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô') {
                const confirmed = document.getElementById('dental-confirm-call').checked;
                if (!confirmed) {
                    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á (‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£+‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î) ‡πÉ‡∏´‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
                    return;
                }
            }

            // 2. Psych Check (NEW)
            const isPsych = department && (department.includes('‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏£‡∏±‡∏Å‡∏©‡πå‡∏à‡∏¥‡∏ï') || department.includes('‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä'));
            if (isPsych && appointmentType === '‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà') {
                const confirmed = document.getElementById('psych-confirm-call').checked;
                if (!confirmed) {
                    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô ‡∏à‡∏ô‡∏ó. ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡πä‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
                    return;
                }
            }
            
            // 3. PT Check
            let extraOptions = {};
            if (department === '‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î') {
                const ptRadios = document.getElementsByName('pt-pmr-status');
                // Only check if radios are visible (meaning it's a new appointment)
                // Use offsetParent check or simpler classList check
                if (!document.getElementById('pt-safety-check').classList.contains('hidden')) {
                    let selected = Array.from(ptRadios).find(r => r.checked);
                    if (!selected) {
                        alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡πå PMR (‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà) ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
                        return;
                    }
                    extraOptions.ptDoctorStatus = selected.value;
                }
            }

            // If pass
            handleAdminActionClick('approve', appointmentId, extraOptions);
        }

        function setupRescheduleAndDeny(appointmentId, isRedirectCase) {
            const rescheduleForm = document.getElementById('admin-reschedule-form');
            const toggleReschedule = () => {
                rescheduleForm.classList.toggle('hidden');
                populateDepartmentDropdown('admin-new-department');
            };
            
            document.getElementById('admin-reschedule-toggle-btn').addEventListener('click', toggleReschedule);
            document.getElementById('admin-reschedule-toggle-btn-processed').addEventListener('click', toggleReschedule);
            
            document.getElementById('ttm-confirm-back-btn').onclick = () => {
                document.getElementById('ttm-confirm-view').classList.add('hidden');
                document.getElementById('admin-action-buttons').classList.remove('hidden');
            };
            document.getElementById('ttm-confirm-approve-btn').onclick = () => {
                handleAdminActionClick('approve', appointmentId);
            };

            const adminDateTimeInput = document.getElementById('admin-new-datetime');
            const adminDatetimeError = document.getElementById('admin-datetime-error');
            
            validateDateTimeInputAndSetMinDate(adminDateTimeInput, adminDatetimeError);
            
            document.getElementById('admin-new-department').addEventListener('change', (e) => {
                const isOther = e.target.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                document.getElementById('admin-other-department-wrapper').classList.toggle('hidden', !isOther);
                document.getElementById('admin-other-department-detail').required = isOther;
            });

            rescheduleForm.onsubmit = (e) => {
                e.preventDefault();
                const newDateTime = document.getElementById('admin-new-datetime').value;
                if (!newDateTime) {
                    document.getElementById('admin-datetime-error').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà';
                    document.getElementById('admin-datetime-error').classList.remove('hidden');
                    return;
                }
                let newDepartment = document.getElementById('admin-new-department').value;
                if (newDepartment === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
                    newDepartment = document.getElementById('admin-other-department-detail').value;
                }
                
                handleAdminActionClick('reschedule', appointmentId, { 
                    newDateTime, 
                    newDepartment: newDepartment || '',
                    isRedirect: isRedirectCase,
                    redirectReason: isRedirectCase ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á+‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå' : ''
                });
            };
        }
        
        function populateDepartmentDropdown(id) {
             const select = document.getElementById(id);
             select.innerHTML = departmentOptionsHTML.replace('<option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>', '<option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á --</option>');
        }

        // --- TTM Self Triage Helper ---
        function getSymptomLabel(key) {
            const map = {
                'fever': '‡πÑ‡∏Ç‡πâ > 38 ‡∏≠‡∏á‡∏®‡∏≤',
                'pain_redness': '‡∏õ‡∏ß‡∏î ‡∏ö‡∏ß‡∏° ‡πÅ‡∏î‡∏á ‡∏£‡πâ‡∏≠‡∏ô',
                'menstruation': '‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                'pregnancy': '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå',
                'stroke_history': '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á',
                'ncd': '‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (NCDs)',
                'muscle_weakness': '‡∏õ‡∏ß‡∏î‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠+‡∏ä‡∏≤/‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á',
                'recent_accident': '‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏´‡∏°‡πà',
                'bone_issue': '‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏´‡∏±‡∏Å/‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô',
                'cancer': '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á'
            };
            return map[key] || key;
        }

        function setupAndShowRegistrationForm() {
           const container = document.getElementById('registration-view');
            container.innerHTML = `
                <h1 class="text-2xl font-bold text-center text-blue-600 mb-4">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h1>
                <p class="text-gray-700 mb-4 text-center">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</p>
                <div id="reg-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
                <form id="registration-form" class="space-y-4">
                    <div><label for="reg-fullname" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠)</label><input type="text" id="reg-fullname" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <p class="text-sm text-gray-600 text-center pt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô:</p>
                    <div><label for="reg-hn" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç HN</label><input type="text" id="reg-hn" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <p class="text-center text-gray-500 text-sm">‡∏´‡∏£‡∏∑‡∏≠</p>
                    <div><label for="reg-thai-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input type="tel" id="reg-thai-id" pattern="\\d{13}" maxlength="13" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="1234567890123"></div>
                    <div class="mt-6 border rounded-md p-4 bg-gray-50"><h3 class="text-base font-semibold text-center mb-3">‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Privacy Notice)</h3><div class="h-40 overflow-y-auto border rounded-md p-3 bg-white text-xs text-gray-600 space-y-2"><p>‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô...</p></div><div class="mt-4"><label class="flex items-center"><input type="checkbox" id="reg-consent-checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded"><span class="ml-2 text-sm text-gray-700">‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ</span></label></div></div>
                    <button type="submit" id="reg-submit-button" class="w-full flex justify-center py-2 px-4 border rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </form>`;
            
            const consentCheckbox = document.getElementById('reg-consent-checkbox');
            const submitButton = document.getElementById('reg-submit-button');
            consentCheckbox.addEventListener('change', () => { submitButton.disabled = !consentCheckbox.checked; });

            document.getElementById('registration-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const regSubmitButton = document.getElementById('reg-submit-button');
                regSubmitButton.disabled = true; regSubmitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...';
                const fullName = document.getElementById('reg-fullname').value;
                const regError = document.getElementById('reg-error-message');
                regError.classList.add('hidden');
                const hn = document.getElementById('reg-hn').value.trim();
                const thaiId = document.getElementById('reg-thai-id').value.trim();
                if (!hn && !thaiId) {
                    regError.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç HN ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á';
                    regError.classList.remove('hidden'); regSubmitButton.disabled = false; regSubmitButton.textContent = '‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                    return;
                }
                try {
                    const response = await postToServer({ action: 'registerUser', userId: userProfile.userId, fullName, hn, thaiId });
                    if (response.data.success) { staffInfo = response.data.staffInfo; setupAndShowMainForm(); } 
                    else { 
                        // ‚úÖ MODIFIED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                        regError.innerHTML = `${response.data.message}<br><br><span class="font-bold underline text-red-800">‡∏´‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏•‡∏ô‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞</span>`;
                        regError.classList.remove('hidden'); 
                        regSubmitButton.disabled = false; 
                        regSubmitButton.textContent = '‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'; 
                    }
                } catch (error) {
                    // ‚úÖ MODIFIED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô catch
                    regError.innerHTML = `${error.message}<br><br><span class="font-bold underline text-red-800">‡∏´‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏•‡∏ô‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞</span>`;
                    regError.classList.remove('hidden'); 
                    regSubmitButton.disabled = false; 
                    regSubmitButton.textContent = '‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                }
            });
            showView('registration-view');
        }
        
        // 1. Checks if the selected date/time meets custom business rules (weekend, working hours, advance booking)
        function checkCustomDateTimeRules(inputElement) {
            if (!inputElement.value) return false;
            
            const now = new Date();
            const minBookingDate = new Date(now);
            minBookingDate.setHours(8, 0, 0, 0); 
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            if (currentHour > 15 || (currentHour === 15 && currentMinute >= 30)) { minBookingDate.setDate(now.getDate() + 2); } 
            else { minBookingDate.setDate(now.getDate() + 1); }

            const selected = new Date(inputElement.value);
            const day = selected.getDay();
            const hour = selected.getHours();
            const minute = selected.getMinutes();

            // Check 1: Weekend
            if (day === 0 || day === 6) return false;
            
            // Check 2: Working Hours
            if (hour < 8 || hour > 15 || (hour === 15 && minute > 30)) return false;
            
            // Check 3: Advance Booking
            const minCompareDate = new Date(minBookingDate.getTime() - 60000); 
            if (selected < minCompareDate) return false;
            
            return true;
        }

        // 2. Handles min date setting, date error display, and calls master checker
        function validateDateTimeInputAndSetMinDate(inputElement, errorElement) {
            
            // --- PART 1: Set Min Date (runs once at setup, and on validation to keep logic centralized) ---
            const now = new Date();
            const minBookingDate = new Date(now);
            minBookingDate.setHours(8, 0, 0, 0); 
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            if (currentHour > 15 || (currentHour === 15 && currentMinute >= 30)) { minBookingDate.setDate(now.getDate() + 2); } 
            else { minBookingDate.setDate(now.getDate() + 1); }
            const tempMinDate = new Date(minBookingDate);
            tempMinDate.setMinutes(tempMinDate.getMinutes() - tempMinDate.getTimezoneOffset());
            inputElement.min = tempMinDate.toISOString().slice(0, 16);
            
            // --- PART 2: Validation Logic (run on input) ---
            const validate = () => {
                const selectedValue = inputElement.value;
                errorElement.classList.add('hidden');
                
                let errorMessage = '';
                if (selectedValue) {
                    const selected = new Date(selectedValue);
                    const day = selected.getDay();
                    const hour = selected.getHours();
                    const minute = selected.getMinutes();
                    
                    if (day === 0 || day === 6) { 
                        errorMessage = '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'; 
                    } else if (hour < 8 || hour > 15 || (hour === 15 && minute > 30)) { 
                        errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 08:00 - 15:30 ‡∏ô.'; 
                    } else {
                        const minCompareDate = new Date(minBookingDate.getTime() - 60000); 
                        if (selected < minCompareDate) {
                            errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤: ';
                            if (currentHour > 15 || (currentHour === 15 && currentMinute >= 30)) { 
                                errorMessage += '‡∏´‡∏•‡∏±‡∏á 15:30‡∏ô. ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏°‡∏∞‡∏£‡∏∑‡∏ô‡∏ô‡∏µ‡πâ'; 
                            } else { 
                                errorMessage += '‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 15:30‡∏ô. ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'; 
                            }
                        }
                    }
                }

                if (errorMessage) {
                    errorElement.textContent = errorMessage; 
                    errorElement.classList.remove('hidden'); 
                } 
                
                checkMasterValidity(); // Always run master check after any validation change
            };
            
            inputElement.addEventListener('input', validate);
            validate(); // Initial run
        }
        
        // 3. Master function to check all validity and toggle the submit button
        function checkMasterValidity() {
            const form = document.getElementById('appointment-form');
            const submitButton = document.getElementById('submit-button');
            const dateTimeInput = document.getElementById('appointment-datetime');
            
            // ‚úÖ FIX 1: Check if the form and submit button elements exist before proceeding.
            if (!form || !submitButton) return; 

            // 1. Check Native HTML Required fields (checks all inputs with 'required', including department and symptoms)
            // Note: form.checkValidity() returns false if any required field is empty.
            const isNativeValid = form.checkValidity(); 

            // 2. Check Custom Date/Time Rules (working hours, advance booking)
            // We only check custom rules if the date field is filled (otherwise native validity handles it)
            const isCustomDateValid = dateTimeInput.value ? checkCustomDateTimeRules(dateTimeInput) : false;
            
            // The button is enabled ONLY if both native (all required fields filled) and custom date/time rules pass.
            // Note: If dateTimeInput.value is empty, isNativeValid is false, and isCustomDateValid is false, disabling the button.
            submitButton.disabled = !(isNativeValid && isCustomDateValid);
            
            // If the button is currently disabled, we can trigger reportValidity to show the missing field tooltip,
            // but we avoid doing this on every input change as it's annoying. We only do it explicitly on submit click (in handleAppointmentSubmit)
        }

        function setupAndShowMainForm() {
            const container = document.getElementById('main-form-view');
            container.innerHTML = `
                <h1 class="text-2xl font-bold text-center text-green-600 mb-4">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h1>
                <div class="bg-blue-50 p-3 rounded-md mb-4"><p class="text-sm text-gray-700">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: <span id="staff-name" class="font-bold"></span></p><p class="text-sm text-gray-700">HN: <span id="staff-hn" class="font-bold"></span></p></div>
                <div id="form-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"></div>
                <form id="appointment-form" class="space-y-4">
                    <fieldset class="border p-4 rounded-md"><legend class="text-lg font-medium text-gray-900 px-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</legend>
                        <div><label for="patient-relation" class="block text-sm font-medium text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</label><select id="patient-relation" name="patient-relation" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"><option>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á</option><option>‡∏ö‡∏¥‡∏î‡∏≤</option><option>‡∏°‡∏≤‡∏£‡∏î‡∏≤</option><option>‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢)</option><option>‡∏ö‡∏∏‡∏ï‡∏£</option><option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select></div>
                        <div id="other-relation-wrapper" class="hidden mt-4"><label for="other-relation-detail" class="block text-sm font-medium">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏</label><input type="text" id="other-relation-detail" name="other-relation-detail" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                        <div class="mt-4"><label for="patient-fullname" class="block text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label><input type="text" id="patient-fullname" name="patient-fullname" required class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                        <div class="mt-4"><label for="patient-id" class="block text-sm font-medium">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" id="patient-id" name="patient-id" maxlength="13" pattern="\\d{13}" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="13 ‡∏´‡∏•‡∏±‡∏Å (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"></div>
                        <div class="mt-4"><label for="patient-phone" class="block text-sm font-medium">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="patient-phone" name="patient-phone" pattern="[0-9]{10}" maxlength="10" required class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                        <div class="mt-4"><label class="block text-sm font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û</label><div class="mt-2 space-x-4"><label class="inline-flex items-center"><input type="radio" name="patient-status" value="‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏î‡πâ" checked class="form-radio"><span class="ml-2">‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏î‡πâ</span></label><label class="inline-flex items-center"><input type="radio" name="patient-status" value="‡∏ô‡∏±‡πà‡∏á‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô" class="form-radio"><span class="ml-2">‡∏ô‡∏±‡πà‡∏á‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô</span></label><label class="inline-flex items-center"><input type="radio" name="patient-status" value="‡∏ô‡∏≠‡∏ô‡πÄ‡∏õ‡∏•" class="form-radio"><span class="ml-2">‡∏ô‡∏≠‡∏ô‡πÄ‡∏õ‡∏•</span></label></div></div>
                    </fieldset>
                    <fieldset class="border p-4 rounded-md"><legend class="text-lg font-medium text-gray-900 px-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</legend>
                        <div><label for="symptoms" class="block text-sm font-medium">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏)</label><textarea id="symptoms" name="symptoms" rows="3" required class="mt-1 block w-full sm:text-sm border-gray-300 rounded-md"></textarea></div>
                        <div class="mt-4"><label for="department" class="block text-sm font-medium">‡πÅ‡∏ú‡∏ô‡∏Å (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏)</label><select id="department" name="department" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">${departmentOptionsHTML}</select></div>
                        
                        <!-- TTM Self Triage Form -->
                        <div id="ttm-triage-wrapper" class="hidden mt-4 p-4 border border-green-200 bg-green-50 rounded-md">
                            <h3 class="font-bold text-green-800 mb-2">üåø ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢)</h3>
                            <p class="text-sm text-gray-600 mb-2">‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠)</p>
                            <div class="space-y-2 text-sm">
                                <!-- Low Risk -->
                                <label class="flex items-center"><input type="checkbox" name="ttm-symptom" value="fever" class="form-checkbox text-green-600"><span class="ml-2">‡πÑ‡∏Ç‡πâ > 38 ‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏ã‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏™</span></label>
                                <label class="flex items-center"><input type="checkbox" name="ttm-symptom" value="pain_redness" class="form-checkbox text-green-600"><span class="ml-2">‡∏õ‡∏ß‡∏î ‡∏ö‡∏ß‡∏° ‡πÅ‡∏î‡∏á ‡∏£‡πâ‡∏≠‡∏ô</span></label>
                                <label class="flex items-center"><input type="checkbox" name="ttm-symptom" value="menstruation" class="form-checkbox text-green-600"><span class="ml-2">‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></label>
                                <label class="flex items-center"><input type="checkbox" name="ttm-symptom" value="pregnancy" class="form-checkbox text-green-600"><span class="ml-2">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</span></label>
                                <label class="flex items-center"><input type="checkbox" name="ttm-symptom" value="stroke_history" class="form-checkbox text-green-600"><span class="ml-2">‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á</span></label>
                                <label class="flex items-center"><input type="checkbox" name="ttm-symptom" value="ncd" class="form-checkbox text-green-600"><span class="ml-2">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (NCDs)</span></label>
                                <!-- High Risk -->
                                <label class="flex items-center"><input type="checkbox" name="ttm-symptom" value="muscle_weakness" class="form-checkbox text-red-600"><span class="ml-2 font-bold text-red-700">‡∏õ‡∏ß‡∏î‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏ä‡∏≤/‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á</span></label>
                                <label class="flex items-center"><input type="checkbox" name="ttm-symptom" value="recent_accident" class="form-checkbox text-red-600"><span class="ml-2 font-bold text-red-700">‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÜ</span></label>
                                <label class="flex items-center"><input type="checkbox" name="ttm-symptom" value="bone_issue" class="form-checkbox text-red-600"><span class="ml-2 font-bold text-red-700">‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏´‡∏±‡∏Å/‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÄ‡∏õ‡∏£‡∏≤‡∏∞/‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</span></label>
                                <label class="flex items-center"><input type="checkbox" name="ttm-symptom" value="cancer" class="form-checkbox text-red-600"><span class="ml-2 font-bold text-red-700">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á</span></label>
                            </div>
                            <!-- Follow up for High Risk -->
                            <div id="ttm-high-risk-followup" class="hidden mt-4 pt-4 border-t border-green-200">
                                <p class="text-sm font-bold text-red-800 mb-2">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á):</p>
                                <p class="text-xs text-gray-700 mb-2">‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏¢‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                                <div class="space-x-4 text-sm">
                                    <label class="inline-flex items-center"><input type="radio" name="ttm-seen-doctor" value="yes" class="form-radio text-green-600"><span class="ml-2">‡πÄ‡∏Ñ‡∏¢‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span></label>
                                    <label class="inline-flex items-center"><input type="radio" name="ttm-seen-doctor" value="no" class="form-radio text-red-600"><span class="ml-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏û‡∏ö</span></label>
                                </div>
                            </div>
                        </div>

                        <div id="dental-options-wrapper" class="hidden mt-4 border-t pt-4">
                            <div><label class="block text-sm font-medium text-gray-700">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</label>
                                <div class="mt-2 space-y-2">
                                    <label class="inline-flex items-center"><input type="radio" name="dental-service" value="‡∏Ç‡∏π‡∏î‡∏´‡∏¥‡∏ô‡∏õ‡∏π‡∏ô" class="form-radio"><span class="ml-2">‡∏Ç‡∏π‡∏î‡∏´‡∏¥‡∏ô‡∏õ‡∏π‡∏ô</span></label>
                                    <label class="inline-flex items-center"><input type="radio" name="dental-service" value="‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô" class="form-radio"><span class="ml-2">‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô</span></label>
                                    <label class="inline-flex items-center"><input type="radio" name="dental-service" value="‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô" class="form-radio"><span class="ml-2">‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô</span></label>
                                    <label class="inline-flex items-center"><input type="radio" name="dental-service" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" class="form-radio"><span class="ml-2">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span></label>
                                </div>
                                <div id="other-dental-service" class="hidden mt-2"><label for="other-dental-service-detail" class="block text-sm font-medium">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏</label><input type="text" id="other-dental-service-detail" name="other-dental-service-detail" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                            </div>
                            <div class="mt-4"><label class="block text-sm font-medium text-gray-700">‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏ü‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</label><div class="mt-2 space-x-4"><label class="inline-flex items-center"><input type="radio" name="dental-pain" value="‡∏°‡∏µ" class="form-radio"><span class="ml-2">‡∏°‡∏µ</span></label><label class="inline-flex items-center"><input type="radio" name="dental-pain" value="‡πÑ‡∏°‡πà‡∏°‡∏µ" class="form-radio"><span class="ml-2">‡πÑ‡∏°‡πà‡∏°‡∏µ</span></label></div></div>
                        </div>
                        
                        <div id="med-warning-wrapper" class="hidden mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700"><p class="font-bold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏ó‡∏£‡∏≤‡∏ö</p><p class="text-sm">‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1-2 ‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏≤‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏±‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÅ‡∏ó‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞</p></div>
                        <div id="other-department-wrapper" class="hidden mt-4"><label for="other-department-detail" class="block text-sm font-medium">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å</label><input type="text" id="other-department-detail" name="other-department-detail" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                        <div class="mt-4"><label class="block text-sm font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏)</label><div class="mt-2 space-x-4"><label class="inline-flex items-center"><input type="radio" name="appointment-type" value="‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà" required class="form-radio"><span class="ml-2">‡∏ô‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</span></label><label class="inline-flex items-center"><input type="radio" name="appointment-type" value="‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°" class="form-radio"><span class="ml-2">‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°</span></label></div></div>
                        <div id="doctor-name-wrapper" class="mt-4 hidden"><label for="doctor-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" id="doctor-name" name="doctor-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                        <div id="follow-up-details" class="hidden mt-4"><label for="follow-up-on-schedule" class="block text-sm font-medium text-gray-700">‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏° (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</label><div class="mt-2 space-x-4"><label class="inline-flex items-center"><input type="radio" name="follow-up-on-schedule" value="‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°" class="form-radio" required><span class="ml-2">‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°</span></label><label class="inline-flex items-center"><input type="radio" name="follow-up-on-schedule" value="‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°" class="form-radio"><span class="ml-2">‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°</span></label></div></div>
                        <div class="mt-4"><label for="appointment-datetime" class="block text-sm font-medium">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î</label><input type="datetime-local" id="appointment-datetime" name="appointment-datetime" required class="mt-1 block w-full px-3 py-2 border rounded-md"><div id="datetime-error" class="hidden mt-1 text-sm text-red-600"></div></div>
                    </fieldset>
                    <div><label for="notes" class="block text-sm font-medium">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="notes" name="notes" rows="2" class="mt-1 block w-full sm:text-sm border-gray-300 rounded-md"></textarea></div>
                    <button id="submit-button" type="button" class="w-full flex justify-center py-2 px-4 border rounded-md text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"><span id="submit-text">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span><div id="submit-spinner" class="spinner hidden" style="width:20px; height:20px; border-left-color: #fff;"></div></button>
                </form>
                <div class="mt-6 text-center"><p class="text-sm text-gray-600">‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p></div>
            `;
            
            document.getElementById('staff-name').textContent = staffInfo.fullName;
            document.getElementById('staff-hn').textContent = staffInfo.hn;
            const relationSelect = document.getElementById('patient-relation');
            const patientNameInput = document.getElementById('patient-fullname');
            if (relationSelect.value === '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á') { patientNameInput.value = staffInfo.fullName; }
            relationSelect.addEventListener('change', (e) => {
                const isOther = e.target.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                document.getElementById('other-relation-wrapper').classList.toggle('hidden', !isOther);
                document.getElementById('other-relation-detail').required = isOther;
                patientNameInput.value = (e.target.value === '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á') ? staffInfo.fullName : '';
                checkMasterValidity(); // Trigger check after relation potentially changes required fields
            });

            // --- REPLACED: Call new validation functions ---
            validateDateTimeInputAndSetMinDate(document.getElementById('appointment-datetime'), document.getElementById('datetime-error'));
            
            // Add listeners to trigger master check when relevant inputs change
            document.getElementById('department').addEventListener('change', checkMasterValidity);
            document.getElementById('symptoms').addEventListener('input', checkMasterValidity);
            document.getElementById('patient-fullname').addEventListener('input', checkMasterValidity);
            document.getElementById('patient-phone').addEventListener('input', checkMasterValidity);
            document.getElementById('patient-id').addEventListener('input', checkMasterValidity);
            document.getElementById('patient-relation').addEventListener('change', checkMasterValidity);
            document.querySelectorAll('input[name="appointment-type"]').forEach(r => r.addEventListener('change', checkMasterValidity));
            // --- END REPLACED ---
            
            // Dept Change Listener with TTM Logic
            document.getElementById('department').addEventListener('change', (e) => {
                const isDental = e.target.value === '‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô';
                const isOther = e.target.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                const isTTM = e.target.value === '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢';
                
                document.getElementById('dental-options-wrapper').classList.toggle('hidden', !isDental);
                document.getElementById('other-department-wrapper').classList.toggle('hidden', !isOther);
                document.getElementById('med-warning-wrapper').classList.toggle('hidden', e.target.value !== '‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°');
                document.getElementById('ttm-triage-wrapper').classList.toggle('hidden', !isTTM);
                
                document.getElementById('other-department-detail').required = isOther;
                document.querySelectorAll('input[name="dental-service"]').forEach(radio => radio.required = isDental);
                document.querySelectorAll('input[name="dental-pain"]').forEach(radio => radio.required = isDental);
                
                checkMasterValidity(); // Re-check after conditional required fields visibility changes
            });

            // TTM High Risk Logic
            const highRiskCheckboxes = document.querySelectorAll('input[name="ttm-symptom"][value="muscle_weakness"], input[name="ttm-symptom"][value="recent_accident"], input[name="ttm-symptom"][value="bone_issue"], input[name="ttm-symptom"][value="cancer"]');
            highRiskCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const anyHighRisk = Array.from(highRiskCheckboxes).some(c => c.checked);
                    document.getElementById('ttm-high-risk-followup').classList.toggle('hidden', !anyHighRisk);
                    checkMasterValidity(); // Re-check after conditional required fields visibility changes
                });
            });

            document.querySelectorAll('input[name="dental-service"]').forEach(r => r.addEventListener('change', (e) => {
                const isOtherDental = e.target.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                document.getElementById('other-dental-service').classList.toggle('hidden', !isOtherDental);
                document.getElementById('other-dental-service-detail').required = isOtherDental;
                checkMasterValidity(); // Re-check after conditional required fields visibility changes
            }));
            
            document.querySelectorAll('input[name="appointment-type"]').forEach(r => r.addEventListener('change', (e) => {
                const isFollowUp = e.target.value === '‡∏ô‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°';
                document.getElementById('follow-up-details').classList.toggle('hidden', !isFollowUp);
                document.getElementById('doctor-name-wrapper').classList.toggle('hidden', !isFollowUp);
                document.querySelectorAll('input[name="follow-up-on-schedule"]').forEach(radio => radio.required = isFollowUp);
                checkMasterValidity(); // Re-check after conditional required fields visibility changes
            }));
            
            document.getElementById('submit-button').addEventListener('click', (e) => {
                const form = document.getElementById('appointment-form');
                handleAppointmentSubmit(e, form);
            });
            
            // Initial check to disable button on load
            checkMasterValidity(); 
            showView('main-form-view');
        }

        async function handleAdminActionClick(adminActionType, appointmentId, options = {}) {
            showView('loading-view');
            try {
                const payload = { 
                    action: 'handleAdminAction', adminActionType: adminActionType, 
                    appointmentId, adminName: userProfile.displayName, 
                    extraOptions: options, ...options // Pass top level or inside extraOptions
                };
                const result = await postToServer(payload);
                if (result.data && result.data.alreadyProcessed) { showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ${result.data.message}`); } 
                else if (result.status === 'success') { liff.closeWindow(); } 
                else { showError(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'); }
            } catch (error) { showError(`[handleAdminAction] ${error.message}`); }
        }
        
        async function handleAppointmentSubmit(e, formElement) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-button');
            const spinner = document.getElementById('submit-spinner');
            const submitText = document.getElementById('submit-text');
            const errorMsgElement = document.getElementById('form-error-message');
            
            // --- Check all validity again before processing ---
            if (!formElement.checkValidity() || !checkCustomDateTimeRules(document.getElementById('appointment-datetime'))) {
                formElement.reportValidity(); 
                
                // If custom date validation failed, force the error display
                if (!checkCustomDateTimeRules(document.getElementById('appointment-datetime'))) {
                    const dateTimeError = document.getElementById('datetime-error');
                    if (dateTimeError.classList.contains('hidden')) {
                        validateDateTimeInputAndSetMinDate(document.getElementById('appointment-datetime'), dateTimeError);
                    }
                }

                submitBtn.disabled = false; spinner.classList.add('hidden'); submitText.classList.remove('hidden');
                return; 
            }
            
            submitBtn.disabled = true; spinner.classList.remove('hidden'); submitText.classList.add('hidden'); errorMsgElement.classList.add('hidden');
            const formData = new FormData(formElement);
            const data = Object.fromEntries(formData.entries());

            const showFormError = (message) => {
                console.error("Validation Error:", message);
                errorMsgElement.textContent = message; errorMsgElement.classList.remove('hidden');
                errorMsgElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                submitBtn.disabled = false; spinner.classList.add('hidden'); submitText.classList.remove('hidden');
            };

            // --- EXPLICIT SYMPTOMS VALIDATION (Redundant if checkValidity() works, but kept for robustness) ---
            if (!data.symptoms || data.symptoms.trim() === '') {
                showFormError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏)" ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                return;
            }

            if (data['patient-relation'] === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' && !data['other-relation-detail']?.trim()) { showFormError('‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ" ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏" ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
            if (data.department === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' && !data['other-department-detail']?.trim()) { showFormError('‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ" ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å" ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
            if (data.department === '‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô' && data['dental-service'] === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' && !data['other-department-detail']?.trim()) { showFormError('‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ" ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏" ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö'); return; }

            // ‚úÖ ADDED: Phone number validation
            if (!data['patient-phone'] || !/^\d{10}$/.test(data['patient-phone'])) {
                showFormError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (10 ‡∏´‡∏•‡∏±‡∏Å)');
                return;
            }

            // TTM Validation
            let ttmSymptoms = [];
            let ttmSeenDoctor = '';
            if (data.department === '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢') {
                ttmSymptoms = formData.getAll('ttm-symptom');
                const highRisks = ['muscle_weakness', 'recent_accident', 'bone_issue', 'cancer'];
                const hasHighRisk = ttmSymptoms.some(s => highRisks.includes(s));
                if (hasHighRisk) {
                     ttmSeenDoctor = data['ttm-seen-doctor'];
                     if (!ttmSeenDoctor) { showFormError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏¢‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á)'); return; }
                }
            }

            let patientRelation = data['patient-relation'] === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? data['other-relation-detail'] : data['patient-relation'];
            let department = data.department === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? data['other-department-detail'] : data.department;
            let dentalService = (data['dental-service'] === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? data['other-dental-service-detail'] : data['dental-service']) || '';

            const appointmentData = {
                action: 'submitAppointment', userId: userProfile.userId, staffFullName: staffInfo.fullName,
                staffHn: staffInfo.hn, patientRelation, patientFullName: data['patient-fullname'],
                patientId: data['patient-id'] || '', patientPhone: data['patient-phone'], 
                patientStatus: data['patient-status'], symptoms: data.symptoms,
                appointmentType: data['appointment-type'], department,
                doctorName: data['doctor-name'] || '', followUpOnSchedule: data['follow-up-on-schedule'] || '', 
                appointmentDateTime: data['appointment-datetime'], notes: data.notes, 
                isOtherRelation: data['patient-relation'] === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', dentalService, dentalPain: data['dental-pain'] || '',
                ttmSymptoms: ttmSymptoms, // Array
                ttmSeenDoctor: ttmSeenDoctor
            };
            
            try { await postToServer(appointmentData); showView('success-view'); } 
            catch (error) { showFormError(error.message); }
        }

        async function postToServer(data) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', body: JSON.stringify(data),
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                });
                if (!response.ok) { const errorText = await response.text(); throw new Error(`Server ${response.status}: ${errorText}`); }
                const result = await response.json();
                if (result.status === 'error') { throw new Error(result.message); }
                return result; 
            } catch (error) { throw error; }
        }

        main();
    </script>
</body>
</html>
