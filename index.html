<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Track - นัดหมายโรงพยาบาล</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .form-label { @apply block text-gray-700 text-sm font-bold mb-2; }
        .form-input, .form-select, .form-textarea { @apply shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline; }
        .submit-btn { @apply bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full transition-colors; }
        .contact-btn { @apply mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full text-center inline-block; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #3498db; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        #custom-modal { background-color: white; padding: 24px; border-radius: 8px; text-align: center; max-width: 90%; width: 400px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        #custom-modal p { margin-bottom: 20px; line-height: 1.6; }
        #custom-modal button { @apply bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-600">กำลังโหลด...</p>
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal-overlay" class="hidden">
        <div id="custom-modal">
            <p id="modal-text"></p>
            <button id="modal-close-btn">ตกลง</button>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="container mx-auto p-4 max-w-lg">
        <!-- Error Display Section -->
        <section id="error-section" class="hidden">
             <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                <p class="font-bold">เกิดข้อผิดพลาดในการเริ่มต้นระบบ</p>
                <p id="error-text"></p>
                <div id="error-details" class="hidden mt-2 text-xs bg-red-200 p-2 rounded break-words"></div>
                <p class="mt-2 text-sm">กรุณาลองใหม่อีกครั้ง หรือติดต่อผู้ดูแล</p>
            </div>
        </section>

        <!-- Registration Section -->
        <section id="registration-section" class="hidden">
            <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                <h1 class="text-2xl font-bold text-gray-800 text-center mb-2">ลงทะเบียนใช้งาน</h1>
                <p id="reg-welcome-message" class="text-center text-gray-600 mb-6"></p>
                <p class="text-center text-sm text-gray-500 mb-6">กรุณากรอกข้อมูลเพื่อเชื่อมต่อบัญชี LINE และเริ่มใช้งานระบบนัดหมาย (ทำเพียงครั้งแรกเท่านั้น)</p>
                <form id="registration-form">
                    <div class="mb-4">
                        <label class="form-label" for="name-input">ชื่อ-นามสกุล (ตามที่ลงทะเบียนกับ รพ.)</label>
                        <input class="form-input" id="name-input" name="name" type="text" placeholder="เช่น สมชาย ใจดี" required>
                    </div>
                    <div class="mb-6">
                        <label class="form-label" for="hn-input">หมายเลข HN</label>
                        <input class="form-input" id="hn-input" name="hn" type="text" placeholder="กรอก HN ของท่าน" required>
                    </div>
                    <div id="registration-error-section" class="mb-4"></div>
                    <button class="submit-btn" type="submit" id="register-button">ลงทะเบียน</button>
                </form>
            </div>
        </section>

        <!-- Appointment Section -->
        <section id="appointment-section" class="hidden">
            <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                <div class="mb-6 text-center">
                    <h1 class="text-2xl font-bold text-gray-800">ทำนัดหมาย Fast Track</h1>
                    <p id="appt-welcome-message" class="text-gray-600"></p>
                </div>
                <form id="appointment-form">
                    <h2 class="text-lg font-semibold mb-2 border-b pb-2">ข้อมูลผู้ป่วย</h2>
                    <div class="mb-4">
                        <label class="form-label" for="relationship">ความสัมพันธ์กับเจ้าหน้าที่</label>
                        <select class="form-select" id="relationship" name="relationship" required>
                            <option value="" disabled selected>-- กรุณาเลือก --</option>
                            <option value="เจ้าหน้าที่เอง">เจ้าหน้าที่เอง</option>
                            <option value="บิดา">บิดา</option>
                            <option value="มารดา">มารดา</option>
                            <option value="คู่สมรส">คู่สมรส (ตามกฎหมาย)</option>
                            <option value="บุตร">บุตร</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="form-label" for="patientName">ชื่อ-นามสกุล ผู้ป่วย</label>
                        <input class="form-input" id="patientName" name="patientName" type="text" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label" for="patientId">หมายเลขบัตรประชาชน ผู้ป่วย</label>
                        <input class="form-input" id="patientId" name="patientId" type="text" pattern="\d{13}" title="กรุณากรอกหมายเลขบัตรประชาชน 13 หลัก" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label" for="physicalState">ลักษณะทางกายภาพ</label>
                        <select class="form-select" id="physicalState" name="physicalState" required>
                            <option value="" disabled selected>-- กรุณาเลือก --</option>
                            <option value="เดินได้">เดินได้</option>
                            <option value="นั่งรถเข็น (Wheelchair)">นั่งรถเข็น (Wheelchair)</option>
                            <option value="นอนเปล (Stretcher)">นอนเปล (Stretcher)</option>
                        </select>
                    </div>
                    
                    <h2 class="text-lg font-semibold mt-6 mb-2 border-b pb-2">รายละเอียดการนัดหมาย</h2>
                    <div class="mb-4">
                        <label class="form-label" for="symptoms">อาการ/เหตุผลที่ต้องการนัด</label>
                        <textarea class="form-textarea" id="symptoms" name="symptoms" rows="3" placeholder="เช่น ปวดท้อง, ติดตามอาการ, ตรวจสุขภาพ" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="form-label" for="appointmentType">ประเภทการนัด</label>
                        <select class="form-select" id="appointmentType" name="appointmentType" required>
                            <option value="" disabled selected>-- กรุณาเลือก --</option>
                            <option value="นัดใหม่">นัดใหม่ (New Case)</option>
                            <option value="ติดตามอาการ">ติดตามอาการ (Follow-up)</option>
                        </select>
                    </div>
                    <div id="follow-up-section" class="hidden border-l-4 border-blue-300 pl-4 mb-4">
                        <div class="mb-4">
                            <label class="form-label" for="department">แผนกที่นัดหมาย</label>
                            <select class="form-select" id="department" name="department">
                                <option value="" disabled selected>-- กรุณาเลือกแผนก --</option>
                                <option value="อายุรกรรม">อายุรกรรม</option>
                                <option value="ศัลยกรรม">ศัลยกรรม</option>
                                <option value="กุมารเวชกรรม">กุมารเวชกรรม</option>
                                <option value="สูติ-นรีเวชกรรม">สูติ-นรีเวชกรรม</option>
                                <option value="อื่นๆ">อื่นๆ (โปรดระบุในหมายเหตุ)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4 grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label" for="desiredDate">วันที่ต้องการนัด</label>
                            <input class="form-input" id="desiredDate" name="desiredDate" type="date" required>
                        </div>
                        <div>
                            <label class="form-label" for="desiredTime">เวลา</label>
                            <input class="form-input" id="desiredTime" name="desiredTime" type="time" min="08:00" max="15:00" required>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="form-label" for="remarks">หมายเหตุ (ถ้ามี)</label>
                        <textarea class="form-textarea" id="remarks" name="remarks" rows="2" placeholder="ข้อมูลเพิ่มเติมที่ต้องการแจ้งเจ้าหน้าที่"></textarea>
                    </div>
                    <button class="submit-btn" type="submit" id="submit-button">ส่งข้อมูลนัดหมาย</button>
                </form>
            </div>
        </section>
    </main>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxjk295arnMPPvlqw8_nrY2U38Ufc0vwa0jy8phw4yWzgkUN_w1kdNSM9foB3-Pq_erOA/exec';
        const LIFF_ID = '2008050252-Dopb2KMZ';

        // --- GLOBAL VARIABLES ---
        let userProfile = null;
        let staffInfo = null;

        // --- DOM ELEMENTS ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalText = document.getElementById('modal-text');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        function initializeApp() {
            initializeLiff();
            setupEventListeners();
        }

        function setupEventListeners() {
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) hideModal();
            });
            modalCloseBtn.addEventListener('click', hideModal);

            document.getElementById('registration-form').addEventListener('submit', handleRegistration);
            document.getElementById('appointment-form').addEventListener('submit', handleAppointmentSubmit);
            document.getElementById('appointmentType').addEventListener('change', toggleFollowUpSection);
            document.getElementById('relationship').addEventListener('change', handleRelationshipChange);
            document.getElementById('desiredDate').addEventListener('input', validateDate);
        }

        // --- LIFF INITIALIZATION ---
        async function initializeLiff() {
            toggleLoading(true, 'กำลังเริ่มต้น...');
            try {
                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href });
                    return;
                }

                userProfile = await liff.getProfile();
                const response = await apiCall({ requestType: 'checkRegistration', lineUserId: userProfile.userId });

                if (response.registered) {
                    staffInfo = response.staffInfo;
                    if (!staffInfo || !staffInfo.name || !staffInfo.hn) {
                        handleCriticalError(
                            "ข้อมูลเจ้าหน้าที่ในระบบไม่สมบูรณ์ กรุณาติดต่อผู้ดูแลค่ะ",
                            { receivedStaffInfo: staffInfo } 
                        );
                    } else {
                        showAppointmentForm();
                    }
                } else {
                    showRegistrationForm();
                }
            } catch (error) {
                console.error('Initialization Error:', error);
                handleCriticalError(
                    `เกิดข้อผิดพลาดในการเริ่มต้น: ${error.message}`,
                    { errorObject: error.toString(), userProfile: userProfile }
                );
            } finally {
                toggleLoading(false);
            }
        }
        
        // --- FORM HANDLERS ---
        async function handleRegistration(event) {
            event.preventDefault();
            const form = event.target;
            const name = form.elements.name.value.trim();
            const hn = form.elements.hn.value.trim();

            if (!name || !hn) {
                showModal('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            toggleLoading(true, 'กำลังลงทะเบียน...');
            try {
                const response = await apiCall({
                    requestType: 'register',
                    lineUserId: userProfile.userId,
                    displayName: userProfile.displayName,
                    name,
                    hn
                });

                if (response.status === 'success') {
                    await showModal('ลงทะเบียนสำเร็จ!', true);
                    initializeApp();
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                console.error('Registration Error:', error);
                showModal(`ลงทะเบียนไม่สำเร็จ: ${error.message}`);
                addContactButton('registration-error-section');
            } finally {
                toggleLoading(false);
            }
        }

        async function handleAppointmentSubmit(event) {
            event.preventDefault();
            
            if (document.getElementById('relationship').value === 'อื่นๆ') {
                showModal('ช่องทางนี้สงวนสิทธิ์สำหรับเจ้าหน้าที่และญาติสายตรงเท่านั้น<br><br>กรุณาติดต่อผ่านช่องทางหลักของโรงพยาบาล');
                return;
            }

            toggleLoading(true, 'กำลังส่งข้อมูล...');
            try {
                const form = event.target;
                const formData = {
                    requestType: 'submitAppointment',
                    lineUserId: userProfile.userId,
                    relationship: form.elements.relationship.value,
                    patientName: form.elements.patientName.value,
                    patientId: form.elements.patientId.value,
                    physicalState: form.elements.physicalState.value,
                    symptoms: form.elements.symptoms.value,
                    appointmentType: form.elements.appointmentType.value,
                    department: form.elements.department.value,
                    desiredDate: form.elements.desiredDate.value,
                    desiredTime: form.elements.desiredTime.value,
                    remarks: form.elements.remarks.value,
                };
                
                const response = await apiCall(formData);
                if (response.status !== 'success') throw new Error(response.message);

                await showModal('ส่งข้อมูลการนัดหมายเรียบร้อย! กรุณารอการยืนยันจากเจ้าหน้าที่ผ่านทาง LINE ค่ะ', true);
                if (liff.isInClient()) liff.closeWindow();

            } catch (error) {
                console.error('Appointment Submission Error:', error);
                showModal(`เกิดข้อผิดพลาด: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        // --- API COMMUNICATION ---
        async function apiCall(body, timeout = 20000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify(body),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const responseText = await response.text();

                if (!response.ok) throw new Error(`Server Error (Status: ${response.status})`);
                
                return JSON.parse(responseText);

            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') throw new Error('การเชื่อมต่อหมดเวลา');
                if (error instanceof SyntaxError) {
                    console.error("Failed to parse JSON response");
                    throw new Error("การตอบกลับจากเซิร์ฟเวอร์ไม่ถูกต้อง");
                }
                throw error;
            }
        }
        
        // --- UI CONTROL FUNCTIONS ---
        function showRegistrationForm() {
            document.getElementById('reg-welcome-message').innerText = `สวัสดีคุณ ${userProfile.displayName}`;
            document.getElementById('registration-section').classList.remove('hidden');
            document.getElementById('appointment-section').classList.add('hidden');
        }

        function showAppointmentForm() {
            document.getElementById('appt-welcome-message').innerText = `นัดหมายในนาม: ${staffInfo.name} (HN: ${staffInfo.hn})`;
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('desiredDate').setAttribute('min', tomorrow.toISOString().split('T')[0]);
            
            document.getElementById('registration-section').classList.add('hidden');
            document.getElementById('appointment-section').classList.remove('hidden');
        }
        
        function handleRelationshipChange() {
            const relationship = document.getElementById('relationship').value;
            const patientNameInput = document.getElementById('patientName');
            
            if (relationship === 'เจ้าหน้าที่เอง' && staffInfo) {
                patientNameInput.value = staffInfo.name;
                patientNameInput.readOnly = true;
                patientNameInput.classList.add('bg-gray-200');
            } else {
                patientNameInput.value = '';
                patientNameInput.readOnly = false;
                patientNameInput.classList.remove('bg-gray-200');
            }
        }

        function toggleFollowUpSection() {
            const isFollowUp = this.value === 'ติดตามอาการ';
            document.getElementById('follow-up-section').classList.toggle('hidden', !isFollowUp);
            document.getElementById('department').required = isFollowUp;
        }

        function validateDate() {
            const selectedDate = new Date(this.value);
            const day = selectedDate.getUTCDay();
            if (day === 0 || day === 6) { // 0 = Sunday, 6 = Saturday
                showModal('ไม่สามารถเลือกวันเสาร์-อาทิตย์ได้ กรุณาเลือกวันทำการค่ะ');
                this.value = '';
            }
        }
        
        function addContactButton(elementId) {
            const container = document.getElementById(elementId);
            if (!container || container.querySelector('.contact-btn')) return;
            const button = document.createElement('a');
            button.href = 'https://page.line.me/wfk5427z';
            button.target = '_blank';
            button.className = 'contact-btn';
            button.innerText = 'ติดต่อเจ้าหน้าที่';
            container.innerHTML = '';
            container.appendChild(button);
        }

        function toggleLoading(isLoading, message = 'กำลังโหลด...') {
            loadingOverlay.querySelector('p').innerText = message;
            loadingOverlay.style.display = isLoading ? 'flex' : 'none';
        }

        function showModal(message, isSuccess = false) {
            return new Promise(resolve => {
                modalText.innerHTML = message;
                modalOverlay.classList.remove('hidden');
                modalCloseBtn.onclick = () => {
                    hideModal();
                    resolve();
                };
            });
        }

        function hideModal() {
            modalOverlay.classList.add('hidden');
        }
        
        function handleCriticalError(message, details = null) {
            document.getElementById('registration-section').classList.add('hidden');
            document.getElementById('appointment-section').classList.add('hidden');

            const errorSection = document.getElementById('error-section');
            const errorText = document.getElementById('error-text');
            const errorDetails = document.getElementById('error-details');
            
            errorText.innerHTML = message;
            
            if (details) {
                errorDetails.textContent = JSON.stringify(details, null, 2);
                errorDetails.classList.remove('hidden');
            } else {
                errorDetails.classList.add('hidden');
            }
            
            errorSection.classList.remove('hidden');
            toggleLoading(false);
        }

    </script>
</body>
</html>

