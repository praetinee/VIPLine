<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Track Appointment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn { @apply font-bold py-2 px-4 rounded text-center; }
        .btn-green { @apply bg-green-500 hover:bg-green-700 text-white; }
        .btn-red { @apply bg-red-500 hover:bg-red-700 text-white; }
        .btn-yellow { @apply bg-yellow-500 hover:bg-yellow-700 text-white; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- All Views (loading, admin, registration, main-form, error) -->
    <!-- ... No changes needed in the HTML structure ... -->

    <script>
        // ... Other parts of the script (CONFIG, main, showView, showError, loadAdminView, setupAdminButtonListeners, handleUserFlow) ...

        document.getElementById('appointment-form').addEventListener('submit', handleAppointmentSubmit);
        
        // ... Other event listeners for appointment-type and patient-relation ...

        async function handleAppointmentSubmit(e) {
            e.preventDefault();
            toggleSubmitSpinner(true);
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // --- KEY CHANGE: Prepare both relation values ---
            const originalRelation = data['patient-relation']; // This will be "อื่นๆ" if selected
            let finalRelation = originalRelation;
            if(originalRelation === 'อื่นๆ') {
                finalRelation = data['other-relation-detail'] || 'อื่นๆ (ไม่ระบุ)'; // Use detail, with fallback
            }

            const appointmentData = {
                action: 'submitAppointment',
                userId: userProfile.userId,
                staffFullName: staffInfo.fullName,
                staffHn: staffInfo.hn,
                patientRelation: finalRelation, // The value for the sheet (e.g., the detailed text)
                originalRelation: originalRelation, // The original selection from the dropdown
                patientFullName: data['patient-fullname'],
                patientId: data['patient-id'],
                patientStatus: data['patient-status'],
                symptoms: data.symptoms,
                appointmentType: data['appointment-type'],
                department: data.department || '',
                followUpOnSchedule: data['follow-up-on-schedule'] || '',
                appointmentDateTime: data['appointment-datetime'],
                notes: data.notes
            };
            
            const formError = document.getElementById('form-error-message');
            try {
                // The special 'if' for "อื่นๆ" is removed. All submissions go to the backend.
                const response = await postToServer(appointmentData);
                if (response.status === 'success') {
                    liff.closeWindow();
                } else {
                    throw new Error(response.message || 'เกิดข้อผิดพลาดที่ไม่รู้จัก');
                }
            } catch (error) {
                formError.textContent = 'เกิดข้อผิดพลาดในการส่งข้อมูล: ' + error.message;
                formError.classList.remove('hidden');
                toggleSubmitSpinner(false);
            }
        }
        
        // ... Other functions (toggleSubmitSpinner, postToServer) ...

        main();
    </script>
</body>
</html>

