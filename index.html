<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Track - นัดหมายโรงพยาบาล</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .form-label { @apply block text-gray-700 text-sm font-bold mb-2; }
        .form-input, .form-select, .form-textarea { @apply shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline; }
        .submit-btn { @apply bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full transition-colors; }
        #status-container { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main Content Area -->
    <main class="container mx-auto p-4 max-w-lg">
        
        <!-- Status Display Section -->
        <section id="status-container" class="bg-white shadow-md rounded px-8 py-6 mb-4">
             <h1 class="text-xl font-bold text-gray-800 text-center mb-4">สถานะการทำงาน</h1>
             <div id="status-log" class="text-sm text-gray-600 space-y-2 h-32 overflow-y-auto bg-gray-50 p-2 border rounded">
                <p>กำลังเริ่มต้นระบบ...</p>
             </div>
        </section>

        <!-- Registration Section -->
        <section id="registration-section" class="hidden bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <h1 class="text-2xl font-bold text-gray-800 text-center mb-2">ลงทะเบียนใช้งาน</h1>
            <p id="reg-welcome-message" class="text-center text-gray-600 mb-6"></p>
            <form id="registration-form">
                <div class="mb-4">
                    <label class="form-label" for="name-input">ชื่อ-นามสกุล (ตามที่ลงทะเบียนกับ รพ.)</label>
                    <input class="form-input" id="name-input" name="name" type="text" required>
                </div>
                <div class="mb-6">
                    <label class="form-label" for="hn-input">หมายเลข HN</label>
                    <input class="form-input" id="hn-input" name="hn" type="text" required>
                </div>
                <button class="submit-btn" type="submit">ลงทะเบียน</button>
            </form>
        </section>

        <!-- Appointment Section -->
        <section id="appointment-section" class="hidden bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <div class="mb-6 text-center">
                <h1 class="text-2xl font-bold text-gray-800">ทำนัดหมาย Fast Track</h1>
                <p id="appt-welcome-message" class="text-gray-600"></p>
            </div>
            <form id="appointment-form">
                <!-- Form fields will be dynamically added here if needed -->
                <p class="text-center">ฟอร์มนัดหมายจะปรากฏที่นี่</p>
            </form>
        </section>
    </main>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // =================================================================
        //                    CONFIGURATION
        // =================================================================
        
        // --- LIFF & BACKEND ---
        // LIFF ID ของคุณ (ไม่เปลี่ยนแปลง)
        const LIFF_ID = '2008050252-Dopb2KMZ'; 
        
        // URL ของ Apps Script ตัวหลัก (ไม่เปลี่ยนแปลง)
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxjk295arnMPPvlqw8_nrY2U38Ufc0vwa0jy8phw4yWzgkUN_w1kdNSM9foB3-Pq_erOA/exec';
        
        // --- NEW LOGGER SYSTEM ---
        // !!! สำคัญ: นำ URL ของ Logger Script ที่สร้างใหม่มาใส่ที่นี่ !!!
        const LOGGER_URL = 'https://script.google.com/macros/s/AKfycbzrXGoAk_lkt62oNywhihoYxtUQHUFa04q8zXOiuRoCyO7gPGbC3xKSozKoqBDxgacyoA/exec';

        // =================================================================
        //                    APPLICATION LOGIC
        // =================================================================

        const statusLog = document.getElementById('status-log');
        let userProfile = null;

        document.addEventListener('DOMContentLoaded', main);

        async function main() {
            addStatusLog('เริ่มต้นการเชื่อมต่อ LIFF...');
            try {
                await liff.init({ liffId: LIFF_ID });
                addStatusLog('liff.init() สำเร็จ');
                await logEvent('SUCCESS', { message: 'liff.init() successful' });

                if (!liff.isLoggedIn()) {
                    addStatusLog('ผู้ใช้ยังไม่ได้ล็อกอิน, กำลังเปลี่ยนหน้าไปหน้าล็อกอิน...');
                    await logEvent('INFO', { message: 'User not logged in, redirecting to login.' });
                    liff.login({ redirectUri: window.location.href });
                    return;
                }
                addStatusLog('ผู้ใช้ล็อกอินแล้ว');

                userProfile = await liff.getProfile();
                addStatusLog(`ดึงโปรไฟล์สำเร็จ: ${userProfile.displayName}`);
                await logEvent('SUCCESS', { message: 'getProfile() successful', profile: userProfile });

                // Check registration status with backend
                addStatusLog('กำลังตรวจสอบสถานะการลงทะเบียน...');
                const response = await apiCall(BACKEND_URL, { requestType: 'checkRegistration', lineUserId: userProfile.userId });
                addStatusLog('ตรวจสอบสถานะการลงทะเบียนสำเร็จ');
                
                if (response.registered) {
                    addStatusLog('ผู้ใช้ลงทะเบียนแล้ว, กำลังแสดงฟอร์มนัดหมาย');
                    showAppointmentForm(response.staffInfo);
                } else {
                    addStatusLog('ผู้ใช้ยังไม่เคยลงทะเบียน, กำลังแสดงฟอร์มลงทะเบียน');
                    showRegistrationForm();
                }

            } catch (error) {
                console.error('Critical Error in main():', error);
                const errorMessage = error.message || 'Unknown error occurred.';
                const errorDetails = {
                    message: errorMessage,
                    code: error.code,
                    stack: error.stack,
                    fullError: JSON.stringify(error)
                };
                addStatusLog(`❌ เกิดข้อผิดพลาดร้ายแรง: ${errorMessage}`, true);
                await logEvent('CRITICAL_ERROR', errorDetails);
            }
        }

        function showRegistrationForm() {
            document.getElementById('status-container').classList.add('hidden');
            const regSection = document.getElementById('registration-section');
            document.getElementById('reg-welcome-message').innerText = `สวัสดีคุณ ${userProfile.displayName}, กรุณาลงทะเบียนเพื่อใช้งาน`;
            regSection.classList.remove('hidden');
        }

        function showAppointmentForm(staffInfo) {
            document.getElementById('status-container').classList.add('hidden');
            const apptSection = document.getElementById('appointment-section');
            document.getElementById('appt-welcome-message').innerText = `ทำการนัดหมายในนาม: ${staffInfo.name} (HN: ${staffInfo.hn})`;
            apptSection.classList.remove('hidden');
        }
        
        // --- UTILITY FUNCTIONS ---

        function addStatusLog(message, isError = false) {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (isError) {
                p.className = 'text-red-600 font-semibold';
            }
            statusLog.appendChild(p);
            statusLog.scrollTop = statusLog.scrollHeight; // Auto-scroll to bottom
        }

        async function logEvent(status, details) {
            try {
                if (LOGGER_URL.includes('YOUR_NEW_LOGGER_SCRIPT_URL')) {
                    addStatusLog('คำเตือน: ยังไม่ได้ตั้งค่า LOGGER_URL', true);
                    return;
                }
                
                const payload = {
                    status: status,
                    details: JSON.stringify(details, null, 2),
                    timestamp: new Date().toISOString()
                };

                // Use navigator.sendBeacon for reliability on page close, or fetch for general logging
                // For simplicity here, we use fetch and ignore response.
                fetch(LOGGER_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    mode: 'no-cors' // Important for this type of logging
                });
            } catch (e) {
                console.error('Failed to log event:', e);
                // Don't show error to user for logging failure
            }
        }

        async function apiCall(url, body) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify(body),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                addStatusLog(`เกิดข้อผิดพลาดในการเรียก API: ${error.message}`, true);
                await logEvent('API_ERROR', { url: url, error: error.message });
                throw error; // Re-throw to be caught by the main function
            }
        }

    </script>
</body>
</html>

