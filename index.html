<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบนัดหมายโรงพยาบาล</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        /* Custom styles for date/time input placeholders */
        input[type="date"]:required:invalid::-webkit-datetime-edit {
            color: transparent;
        }
        input[type="date"]:focus::-webkit-datetime-edit {
            color: black !important;
        }
         input[type="time"]:required:invalid::-webkit-datetime-edit {
            color: transparent;
        }
        input[type="time"]:focus::-webkit-datetime-edit {
            color: black !important;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main Container -->
    <div id="app-container" class="max-w-lg mx-auto p-4 min-h-screen bg-white">

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        </div>
        
        <!-- Header -->
        <header class="text-center py-4 border-b">
             <h1 class="text-2xl font-bold text-blue-600">ระบบนัดหมายโรงพยาบาล</h1>
             <p id="user-display-name" class="text-gray-600 mt-1"></p>
        </header>

        <!-- Registration Form -->
        <div id="registration-form-container" class="hidden mt-6">
            <h2 class="text-xl font-semibold mb-4 text-center text-gray-800">ลงทะเบียนเข้าใช้งาน</h2>
            <form id="registration-form" class="space-y-4">
                <div>
                    <label for="reg-name" class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล (ตรงกับที่ลงทะเบียน)</label>
                    <input type="text" id="reg-name" name="name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="reg-hn" class="block text-sm font-medium text-gray-700">หมายเลข HN</label>
                    <input type="text" id="reg-hn" name="hn" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 font-semibold">ลงทะเบียน</button>
            </form>
        </div>

        <!-- Appointment Form -->
        <div id="appointment-form-container" class="hidden mt-6">
            <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg mb-4">
                <p class="text-center font-semibold text-blue-800">เจ้าหน้าที่: <span id="staff-name"></span></p>
                <p class="text-center text-sm text-blue-700">HN: <span id="staff-hn"></span></p>
            </div>
            <h2 class="text-xl font-semibold mb-4 text-center text-gray-800">ฟอร์มทำนัดหมาย</h2>
            <form id="appointment-form" class="space-y-4">
                 <div>
                    <label for="relationship" class="block text-sm font-medium text-gray-700">ความสัมพันธ์กับเจ้าหน้าที่</label>
                    <select id="relationship" name="relationship" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="เจ้าหน้าที่เอง">เจ้าหน้าที่เอง</option>
                        <option value="บิดา">บิดา</option>
                        <option value="มารดา">มารดา</option>
                        <option value="คู่สมรส">คู่สมรส</option>
                        <option value="บุตร">บุตร</option>
                    </select>
                </div>
                <div>
                    <label for="patientName" class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุลผู้ป่วย</label>
                    <input type="text" id="patientName" name="patientName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="patientId" class="block text-sm font-medium text-gray-700">เลขบัตรประชาชนผู้ป่วย (13 หลัก)</label>
                    <input type="text" id="patientId" name="patientId" pattern="\d{13}" title="กรุณากรอกเลขบัตรประชาชน 13 หลัก" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                 <div>
                    <label for="physicalState" class="block text-sm font-medium text-gray-700">ลักษณะทางกายภาพ</label>
                    <select id="physicalState" name="physicalState" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="เดินได้">เดินได้</option>
                        <option value="นั่งรถเข็น">นั่งรถเข็น</option>
                        <option value="นอนเปล">นอนเปล</option>
                    </select>
                </div>
                <div>
                    <label for="symptoms" class="block text-sm font-medium text-gray-700">อาการเบื้องต้น</label>
                    <textarea id="symptoms" name="symptoms" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                <div>
                    <label for="appointmentType" class="block text-sm font-medium text-gray-700">ประเภทการนัด</label>
                    <select id="appointmentType" name="appointmentType" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="นัดใหม่">นัดใหม่</option>
                        <option value="ติดตามอาการ">ติดตามอาการ</option>
                    </select>
                </div>
                 <!-- Conditional fields for "ติดตามอาการ" -->
                <div id="follow-up-section" class="hidden space-y-4 border-l-4 border-blue-300 pl-4 py-2">
                     <div>
                        <label for="department" class="block text-sm font-medium text-gray-700">แผนก</label>
                        <select id="department" name="department" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                             <option value="">-- เลือกแผนก --</option>
                             <option value="อายุรกรรม">อายุรกรรม</option>
                             <option value="ศัลยกรรม">ศัลยกรรม</option>
                             <option value="กุมารเวชกรรม">กุมารเวชกรรม</option>
                             <option value="สูติ-นรีเวชกรรม">สูติ-นรีเวชกรรม</option>
                             <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div>
                        <span class="block text-sm font-medium text-gray-700">ประเภทการติดตาม</span>
                        <div class="mt-2 space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="followUpType" value="มาตามนัดเดิม" class="form-radio text-blue-600">
                                <span class="ml-2">มาตามนัดเดิม</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="followUpType" value="ไม่ได้มาตามนัด" class="form-radio text-blue-600">
                                <span class="ml-2">ไม่ได้มาตามนัด</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="desiredDate" class="block text-sm font-medium text-gray-700">วันที่ต้องการนัด</label>
                    <input type="date" id="desiredDate" name="desiredDate" placeholder="เลือกวันที่" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>

                <div>
                    <label for="desiredTime" class="block text-sm font-medium text-gray-700">เวลาที่ต้องการนัด (08:00 - 15:00)</label>
                    <input type="time" id="desiredTime" name="desiredTime" min="08:00" max="15:00" placeholder="เลือกเวลา" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>

                 <div>
                    <label for="remarks" class="block text-sm font-medium text-gray-700">หมายเหตุ (ถ้ามี)</label>
                    <textarea id="remarks" name="remarks" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 font-semibold">ส่งข้อมูลนัดหมาย</button>
            </form>
        </div>
    </div>

    <!-- Modal -->
    <div id="feedback-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full">
             <!-- Icon will be inserted by JS -->
          </div>
          <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
          <div class="mt-2 px-7 py-3">
            <p id="modal-message" class="text-sm text-gray-500"></p>
          </div>
          <div class="items-center px-4 py-3">
            <button id="modal-close-button" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
              ปิด
            </button>
          </div>
        </div>
      </div>
    </div>


    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "2008050252-Dopb2KMZ";
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx534knr6WfJLsCUG2RKoTs-PExoCZvjlObK65gzfq3tiaSvnNZwRX-rN6bvsWb9k4WMw/exec"; // <-- TODO: REPLACE WITH YOUR DEPLOYMENT ID

        // --- DOM ELEMENTS ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const userDisplayNameEl = document.getElementById('user-display-name');
        const regFormContainer = document.getElementById('registration-form-container');
        const apptFormContainer = document.getElementById('appointment-form-container');
        const regForm = document.getElementById('registration-form');
        const apptForm = document.getElementById('appointment-form');
        const staffNameEl = document.getElementById('staff-name');
        const staffHnEl = document.getElementById('staff-hn');
        const followUpSection = document.getElementById('follow-up-section');
        const appointmentTypeSelect = document.getElementById('appointmentType');
        const desiredDateInput = document.getElementById('desiredDate');
        const relationshipSelect = document.getElementById('relationship');
        const patientNameInput = document.getElementById('patientName');
        
        // Modal elements
        const modal = document.getElementById('feedback-modal');
        const modalIcon = document.getElementById('modal-icon');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');


        let userProfile = {};

        // --- MAIN FUNCTION ---
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                await initializeLiff();
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                userDisplayNameEl.textContent = `สวัสดี, ${userProfile.displayName}`;
                
                await checkUserRegistration();
            } catch (error) {
                console.error("Initialization failed:", error);
                showModal('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถเริ่มต้นแอปพลิเคชันได้ กรุณาลองใหม่อีกครั้ง');
            }
        });

        // --- LIFF INITIALIZATION ---
        async function initializeLiff() {
            await liff.init({ liffId: LIFF_ID });
        }

        // --- API CALLS ---
        async function postToServer(requestType, payload) {
            loadingSpinner.style.display = 'flex';
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for Google Apps Script web apps
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ requestType, ...payload }),
                     redirect: 'follow'
                });
                // Since it's a 'no-cors' request, we can't read the response directly.
                // We assume success and let the backend handle notifications.
                // The proper way would be a more complex setup, but this works for simple cases.
                // We will manually fetch status later if needed. For now, we just proceed.
                return { status: 'success' }; // Mock success for no-cors
            } catch (error) {
                console.error('API call failed:', error);
                return { status: 'error', message: error.message };
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
        
        // This is a workaround to get response from a POST request to Google Apps Script
        async function postAndGetResponse(requestType, payload) {
            loadingSpinner.style.display = 'flex';
            try {
                // This is a trick: We create a temporary form to submit the data,
                // which allows us to bypass some CORS issues for simple JSON responses.
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ requestType, ...payload })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result;

            } catch (error) {
                console.error('API call failed:', error);
                showModal('error', 'การเชื่อมต่อล้มเหลว', 'ไม่สามารถติดต่อเซิร์ฟเวอร์ได้');
                return { status: 'error', message: error.message };
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }


        // --- REGISTRATION LOGIC ---
        async function checkUserRegistration() {
            const payload = { lineUserId: userProfile.userId };
            const result = await postAndGetResponse('checkRegistration', payload);

            if (result && result.status === 'success') {
                if (result.registered) {
                    displayAppointmentForm(result.staffInfo);
                } else {
                    displayRegistrationForm();
                }
            } else {
                showModal('error', 'ตรวจสอบข้อมูลล้มเหลว', result.message || 'ไม่สามารถตรวจสอบสถานะการลงทะเบียนได้');
            }
        }

        regForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(regForm);
            const payload = {
                lineUserId: userProfile.userId,
                displayName: userProfile.displayName,
                name: formData.get('name'),
                hn: formData.get('hn')
            };
            const result = await postAndGetResponse('register', payload);

            if (result && result.status === 'success') {
                showModal('success', 'ลงทะเบียนสำเร็จ', 'คุณได้ลงทะเบียนเข้าสู่ระบบเรียบร้อยแล้ว', checkUserRegistration);
            } else {
                showModal('error', 'ลงทะเบียนไม่สำเร็จ', result.message || 'กรุณาตรวจสอบข้อมูลและลองอีกครั้ง');
            }
        });


        // --- APPOINTMENT LOGIC ---
        apptForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(apptForm);
            const payload = {
                lineUserId: userProfile.userId,
                relationship: formData.get('relationship'),
                patientName: formData.get('patientName'),
                patientId: formData.get('patientId'),
                physicalState: formData.get('physicalState'),
                symptoms: formData.get('symptoms'),
                appointmentType: formData.get('appointmentType'),
                department: formData.get('department') || '',
                followUpType: formData.get('followUpType') || '',
                desiredDate: formData.get('desiredDate'),
                desiredTime: formData.get('desiredTime'),
                remarks: formData.get('remarks')
            };
            
            // Re-post to the server without expecting a readable response
            await postToServer('submitAppointment', payload);
            
            showModal('success', 'ส่งข้อมูลสำเร็จ', 'เราได้รับข้อมูลการนัดหมายของท่านแล้ว กรุณารอการยืนยันจากเจ้าหน้าที่', () => {
                liff.closeWindow();
            });
        });
        
        // --- UI RENDERING ---
        function displayRegistrationForm() {
            regFormContainer.classList.remove('hidden');
            apptFormContainer.classList.add('hidden');
            loadingSpinner.style.display = 'none';
        }

        function displayAppointmentForm(staffInfo) {
            staffNameEl.textContent = staffInfo.name;
            staffHnEl.textContent = staffInfo.hn;
            apptFormContainer.classList.remove('hidden');
            regFormContainer.classList.add('hidden');
            loadingSpinner.style.display = 'none';
        }

        // --- UI HELPERS & VALIDATION ---
        appointmentTypeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'ติดตามอาการ') {
                followUpSection.classList.remove('hidden');
                document.getElementById('department').required = true;
                document.querySelector('input[name="followUpType"]').required = true;

            } else {
                followUpSection.classList.add('hidden');
                document.getElementById('department').required = false;
                document.querySelector('input[name="followUpType"]').required = false;
            }
        });
        
        relationshipSelect.addEventListener('change', e => {
            if (e.target.value === 'เจ้าหน้าที่เอง') {
                patientNameInput.value = staffNameEl.textContent;
            } else {
                patientNameInput.value = '';
            }
        });
        
        desiredDateInput.addEventListener('change', (e) => {
            const selectedDate = new Date(e.target.value);
            const dayOfWeek = selectedDate.getDay(); // Sunday = 0, Saturday = 6
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                e.target.value = '';
                showModal('error', 'เลือกวันไม่ถูกต้อง', 'กรุณาเลือกวันจันทร์ - ศุกร์');
            }
        });
        
        // Set min date for date input to today
        const today = new Date().toISOString().split('T')[0];
        desiredDateInput.setAttribute('min', today);


        // --- MODAL ---
        function showModal(type, title, message, callback) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;

            modalIcon.innerHTML = ''; // Clear previous icon
            modalIcon.classList.remove('bg-green-100', 'bg-red-100');


            if (type === 'success') {
                modalIcon.classList.add('bg-green-100');
                modalIcon.innerHTML = `<svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
            } else { // error
                modalIcon.classList.add('bg-red-100');
                modalIcon.innerHTML = `<svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
            }

            modal.style.display = 'block';

            // Handle close button click
            modalCloseButton.onclick = () => {
                modal.style.display = 'none';
                if (callback) {
                    callback();
                }
            };
        }
    </script>
</body>
</html>
