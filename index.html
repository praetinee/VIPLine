<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบนัดหมาย Fast Track</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .form-label {
            @apply block text-gray-700 text-sm font-bold mb-2;
        }
        .form-input, .form-select, .form-textarea {
            @apply shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .btn {
            @apply font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full;
        }
        .btn-primary {
            @apply bg-blue-500 hover:bg-blue-700 text-white;
        }
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-700 text-white;
        }
        .radio-group {
            @apply flex items-center space-x-4 mt-2;
        }
        .radio-label {
            @apply flex items-center;
        }
        .radio-input {
            @apply mr-2;
        }
        #loading-overlay, #message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Spinner -->
    <div id="loading-overlay">
        <div class="loader mb-4"></div>
        <p>กำลังโหลดข้อมูล กรุณารอสักครู่...</p>
    </div>

    <!-- Message Overlay -->
    <div id="message-overlay" class="hidden">
        <h2 id="message-title" class="text-2xl font-bold mb-4"></h2>
        <p id="message-body"></p>
        <button id="close-message-btn" class="btn btn-primary mt-6 w-auto px-8">ปิด</button>
    </div>

    <div id="main-content" class="container mx-auto p-4 max-w-lg hidden">

        <!-- Registration Form -->
        <div id="registration-form" class="bg-white p-6 rounded-xl shadow-md hidden">
            <h1 class="text-2xl font-bold mb-4 text-center text-blue-600">ลงทะเบียนสำหรับเจ้าหน้าที่</h1>
            <p class="text-center text-gray-600 mb-6">กรุณากรอกข้อมูลเพื่อยืนยันตัวตน (เฉพาะครั้งแรก)</p>
            <div class="mb-4">
                <label class="form-label" for="staff-fullname">ชื่อ-นามสกุล</label>
                <input class="form-input" id="staff-fullname" type="text" placeholder="ชื่อ-นามสกุล">
            </div>
            <div class="mb-6">
                <label class="form-label" for="staff-hn">หมายเลข HN</label>
                <input class="form-input" id="staff-hn" type="text" placeholder="HN">
            </div>
            <button id="register-btn" class="btn btn-primary">ลงทะเบียน</button>
            <button id="contact-admin-register-btn" class="btn btn-secondary mt-3">ลงทะเบียนไม่ได้? ติดต่อเจ้าหน้าที่</button>
        </div>

        <!-- Appointment Form -->
        <div id="appointment-form" class="bg-white p-6 rounded-xl shadow-md hidden">
            <h1 class="text-2xl font-bold mb-2 text-center text-blue-600">นัดหมาย Fast Track</h1>
            <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-md">
                <p class="font-bold">เจ้าหน้าที่:</p>
                <p id="staff-info">คุณ [ชื่อ-นามสกุล] (HN: [HN])</p>
            </div>

            <form id="booking-form">
                <div class="mb-4">
                    <label class="form-label" for="relationship">ผู้เข้ารับการรักษา</label>
                    <select class="form-select" id="relationship" required>
                        <option value="">-- เลือกความสัมพันธ์ --</option>
                        <option value="ตัวเจ้าหน้าที่เอง">ตัวเจ้าหน้าที่เอง</option>
                        <option value="พ่อ">พ่อ</option>
                        <option value="แม่">แม่</option>
                        <option value="คู่สมรส">คู่สมรส (ตามกฎหมาย)</option>
                        <option value="บุตร">บุตร</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                </div>
                
                <div id="other-relationship-wrapper" class="mb-4 hidden">
                     <label class="form-label" for="other-relationship-detail">โปรดระบุความสัมพันธ์</label>
                     <input class="form-input" id="other-relationship-detail" type="text" placeholder="เช่น ปู่, ย่า, พี่, น้อง">
                </div>

                <div class="mb-4">
                    <label class="form-label" for="patient-name">ชื่อ-นามสกุล ผู้ป่วย</label>
                    <input class="form-input" id="patient-name" type="text" placeholder="ชื่อ-นามสกุล" required>
                </div>

                <div class="mb-4">
                    <label class="form-label" for="patient-cid">เลขบัตรประชาชน ผู้ป่วย</label>
                    <input class="form-input" id="patient-cid" type="text" placeholder="13 หลัก" required maxlength="13" pattern="\d{13}">
                </div>

                <div class="mb-4">
                    <label class="form-label">สถานะทางกายภาพ</label>
                    <div class="radio-group">
                        <label class="radio-label"><input type="radio" name="physical-status" value="เดินได้" class="radio-input" checked> เดินได้</label>
                        <label class="radio-label"><input type="radio" name="physical-status" value="นั่งรถเข็น" class="radio-input"> นั่งรถเข็น</label>
                        <label class="radio-label"><input type="radio" name="physical-status" value="นอนเปล" class="radio-input"> นอนเปล</label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label" for="symptoms">อาการ/ความผิดปกติ</label>
                    <textarea class="form-textarea" id="symptoms" rows="3" placeholder="ระบุอาการเบื้องต้น" required></textarea>
                </div>

                <div class="mb-4">
                    <label class="form-label">ประเภทนัด</label>
                    <div class="radio-group">
                        <label class="radio-label"><input type="radio" name="appointment-type" value="นัดใหม่" class="radio-input" checked> นัดใหม่</label>
                        <label class="radio-label"><input type="radio" name="appointment-type" value="นัดเดิม" class="radio-input"> นัดเดิม</label>
                    </div>
                </div>

                <div id="follow-up-details" class="hidden bg-gray-50 p-4 rounded-lg mb-4 border">
                    <div class="mb-4">
                        <label class="form-label" for="department">แผนกที่มีนัด</label>
                        <input class="form-input" id="department" type="text" placeholder="ระบุแผนก">
                    </div>
                    <div>
                        <label class="form-label">สถานะการมาตามนัดเดิม</label>
                        <div class="radio-group">
                             <label class="radio-label"><input type="radio" name="follow-up-status" value="มาตรงตามนัด" class="radio-input"> มาตรงตามนัด</label>
                             <label class="radio-label"><input type="radio" name="follow-up-status" value="ไม่ได้มาตามนัด" class="radio-input"> ไม่ได้มาตามนัด</label>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label" for="appointment-datetime">วันและเวลาที่ต้องการนัด</label>
                    <input class="form-input" id="appointment-datetime" type="datetime-local" required>
                    <p class="text-xs text-red-500 mt-1">** สามารถนัดได้เฉพาะวันจันทร์-ศุกร์ เวลา 08:00 - 15:00 น. **</p>
                </div>
                
                <div class="mb-6">
                    <label class="form-label" for="notes">หมายเหตุ/ข้อมูลเพิ่มเติม</label>
                    <textarea class="form-textarea" id="notes" rows="2" placeholder="(ถ้ามี)"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">ส่งข้อมูลนัดหมาย</button>
                 <button id="contact-admin-booking-btn" type="button" class="btn btn-secondary mt-3">นัดหมายไม่ได้? ติดต่อเจ้าหน้าที่</button>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "2008050252-bNYeKBrd";
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwsJTl6er6w5QFsCR-HIJh_mU3gQXzOKchaUlgNKm8_JOqbZfNggyDVrFBvNlUHOSaR/exec";
        const ADMIN_CONTACT_PHONE = "053921199";

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const messageOverlay = document.getElementById('message-overlay');
        const messageTitle = document.getElementById('message-title');
        const messageBody = document.getElementById('message-body');
        const closeMessageBtn = document.getElementById('close-message-btn');
        const mainContent = document.getElementById('main-content');
        const registrationForm = document.getElementById('registration-form');
        const appointmentForm = document.getElementById('appointment-form');
        const registerBtn = document.getElementById('register-btn');
        const bookingForm = document.getElementById('booking-form');
        const relationshipSelect = document.getElementById('relationship');
        const staffInfoEl = document.getElementById('staff-info');

        let userProfile = null;

        // --- Main Function ---
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                await checkUserRegistration();
            } catch (error) {
                console.error("LIFF Initialization Error:", error);
                showMessage("เกิดข้อผิดพลาด", `ไม่สามารถเริ่มต้น LIFF ได้: ${error.message}`);
            }
        }

        // --- Helper Functions ---
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        function showMessage(title, body, onClose) {
            messageTitle.textContent = title;
            messageBody.textContent = body;
            messageOverlay.classList.remove('hidden');
            
            const closeHandler = () => {
                messageOverlay.classList.add('hidden');
                if(onClose) onClose();
                closeMessageBtn.removeEventListener('click', closeHandler);
            };
            closeMessageBtn.addEventListener('click', closeHandler);
        }

        async function postToGas(payload) {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Use no-cors for this type of request to GAS
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                // Note: With 'no-cors', we can't read the response body directly.
                // We rely on the backend to perform actions and handle errors.
                // For direct feedback, a different GAS setup is needed.
                return { success: true };
            } catch (error) {
                console.error('Error posting to GAS:', error);
                return { success: false, error: error };
            }
        }
        
        async function fetchFromGas(params) {
            const url = new URL(GAS_WEB_APP_URL);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching from GAS:', error);
                throw error;
            }
        }

        // --- Core Logic ---
        async function checkUserRegistration() {
            showLoading(true);
            try {
                const result = await fetchFromGas({ action: 'checkUser', userId: userProfile.userId });
                if (result.isRegistered) {
                    staffInfoEl.textContent = `คุณ ${result.staffName} (HN: ${result.staffHn})`;
                    appointmentForm.dataset.staffName = result.staffName;
                    appointmentForm.dataset.staffHn = result.staffHn;
                    showView('appointment');
                } else {
                    showView('register');
                }
            } catch (error) {
                showMessage("เกิดข้อผิดพลาด", "ไม่สามารถตรวจสอบข้อมูลการลงทะเบียนได้ กรุณาลองใหม่อีกครั้ง");
            } finally {
                showLoading(false);
            }
        }

        function showView(viewName) {
            mainContent.classList.remove('hidden');
            registrationForm.classList.add('hidden');
            appointmentForm.classList.add('hidden');

            if (viewName === 'register') {
                registrationForm.classList.remove('hidden');
            } else if (viewName === 'appointment') {
                appointmentForm.classList.remove('hidden');
            }
        }
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', main);

        registerBtn.addEventListener('click', async () => {
            const fullname = document.getElementById('staff-fullname').value.trim();
            const hn = document.getElementById('staff-hn').value.trim();

            if (!fullname || !hn) {
                showMessage("ข้อมูลไม่ครบถ้วน", "กรุณากรอกชื่อ-นามสกุล และหมายเลข HN ให้ครบถ้วน");
                return;
            }

            showLoading(true);
            try {
                 const result = await fetchFromGas({
                     action: 'registerUser',
                     userId: userProfile.userId,
                     displayName: userProfile.displayName,
                     fullname: fullname,
                     hn: hn
                 });

                 if (result.success) {
                     showMessage("ลงทะเบียนสำเร็จ", "ท่านสามารถเริ่มทำนัดหมายได้เลย", () => {
                         checkUserRegistration(); // Re-check to move to appointment form
                     });
                 } else {
                     showMessage("ลงทะเบียนไม่สำเร็จ", result.message || "ไม่พบข้อมูลของท่านในระบบ หรือข้อมูลไม่ถูกต้อง กรุณาตรวจสอบและลองใหม่อีกครั้ง");
                 }
            } catch (error) {
                 showMessage("เกิดข้อผิดพลาด", "การเชื่อมต่อกับเซิร์ฟเวอร์ล้มเหลว กรุณาลองใหม่อีกครั้ง");
            } finally {
                 showLoading(false);
            }
        });

        relationshipSelect.addEventListener('change', (e) => {
            const patientNameInput = document.getElementById('patient-name');
            const otherWrapper = document.getElementById('other-relationship-wrapper');
            if (e.target.value === 'ตัวเจ้าหน้าที่เอง') {
                patientNameInput.value = appointmentForm.dataset.staffName;
                patientNameInput.readOnly = true;
            } else {
                patientNameInput.value = '';
                patientNameInput.readOnly = false;
            }
            
            if (e.target.value === 'อื่นๆ') {
                otherWrapper.classList.remove('hidden');
            } else {
                otherWrapper.classList.add('hidden');
            }
        });

        document.querySelectorAll('input[name="appointment-type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const followUpDetails = document.getElementById('follow-up-details');
                if (e.target.value === 'นัดเดิม') {
                    followUpDetails.classList.remove('hidden');
                } else {
                    followUpDetails.classList.add('hidden');
                }
            });
        });

        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // --- Validation ---
            const appointmentDtInput = document.getElementById('appointment-datetime');
            const selectedDateTime = new Date(appointmentDtInput.value);
            const day = selectedDateTime.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const hour = selectedDateTime.getHours();

            if (day === 0 || day === 6) {
                showMessage("เลือกวันไม่ถูกต้อง", "กรุณาเลือกวันนัดหมายในวันจันทร์ - ศุกร์เท่านั้น");
                return;
            }
            if (hour < 8 || hour >= 15) {
                showMessage("เลือกเวลาไม่ถูกต้อง", "กรุณาเลือกเวลานัดหมายระหว่าง 08:00 - 15:00 น.");
                return;
            }

            // --- Data Collection ---
            const relationship = document.getElementById('relationship').value;
            const otherRelationshipDetail = document.getElementById('other-relationship-detail').value.trim();
            const fullRelationship = relationship === 'อื่นๆ' ? `อื่นๆ (${otherRelationshipDetail})` : relationship;
            
            const appointmentType = document.querySelector('input[name="appointment-type"]:checked').value;
            let department = '', followUpStatus = '';
            if(appointmentType === 'นัดเดิม') {
                department = document.getElementById('department').value.trim();
                const followUpStatusEl = document.querySelector('input[name="follow-up-status"]:checked');
                if(!department || !followUpStatusEl){
                     showMessage("ข้อมูลไม่ครบถ้วน", "กรุณาระบุแผนกและสถานะการมาตามนัดเดิม");
                     return;
                }
                followUpStatus = followUpStatusEl.value;
            }

            const formData = {
                action: 'bookAppointment',
                userId: userProfile.userId,
                staffName: appointmentForm.dataset.staffName,
                staffHn: appointmentForm.dataset.staffHn,
                relationship: fullRelationship,
                isOtherRelationship: relationship === 'อื่นๆ',
                patientName: document.getElementById('patient-name').value.trim(),
                patientCid: document.getElementById('patient-cid').value.trim(),
                physicalStatus: document.querySelector('input[name="physical-status"]:checked').value,
                symptoms: document.getElementById('symptoms').value.trim(),
                appointmentType: appointmentType,
                department: department,
                followUpStatus: followUpStatus,
                appointmentDateTime: appointmentDtInput.value,
                notes: document.getElementById('notes').value.trim(),
            };
            
            showLoading(true);
            try {
                // For 'no-cors' mode, we won't get a readable response.
                // We'll just assume success and let the backend handle sending messages.
                await postToGas(formData);
                showMessage("ส่งข้อมูลสำเร็จ", "เราได้ส่งข้อมูลการนัดหมายของท่านแล้ว กรุณาตรวจสอบสถานะในห้องแชท LINE และรอการยืนยันจากเจ้าหน้าที่", () => {
                    liff.closeWindow();
                });

            } catch(error) {
                console.error("Booking Error:", error);
                showMessage("เกิดข้อผิดพลาด", "ไม่สามารถส่งข้อมูลการนัดหมายได้ กรุณาลองใหม่อีกครั้ง");
            } finally {
                showLoading(false);
            }
        });
        
        // Contact Admin Buttons
        document.getElementById('contact-admin-register-btn').addEventListener('click', () => {
            window.location.href = `tel:${ADMIN_CONTACT_PHONE}`;
        });
         document.getElementById('contact-admin-booking-btn').addEventListener('click', () => {
            window.location.href = `tel:${ADMIN_CONTACT_PHONE}`;
        });

    </script>
</body>
</html>

